<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ - ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f4f1ea; 
            color: #2c3e2d;
            -webkit-tap-highlight-color: transparent;
        }
        .bg-kanam { background-color: #2c3e2d; }
        .text-kanam { color: #2c3e2d; }
        
        .room-dot {
            position: absolute;
            width: 28px;
            height: 28px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            transition: all 0.2s;
        }
        .room-available { background-color: #10b981; }
        .room-selected { background-color: #3b82f6; transform: translate(-50%, -50%) scale(1.2); z-index: 10; }
        .room-booked { background-color: #ef4444; cursor: not-allowed; }

        input:focus, select:focus {
            outline: none;
            border-color: #2c3e2d;
            ring: 1px;
            ring-color: #2c3e2d;
        }

        .step-inactive { display: none; }
    </style>
</head>
<body class="pb-20">
    <!-- Header -->
    <header class="bg-kanam text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <h1 class="text-xl font-bold">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥</h1>
            <div id="user-profile" class="flex items-center gap-2">
                <span id="display-name" class="text-xs opacity-80">Loading...</span>
                <img id="user-img" src="" class="w-8 h-8 rounded-full border border-white hidden">
            </div>
        </div>
    </header>

    <main class="max-w-lg mx-auto p-4 space-y-6">
        
        <!-- Step 1: Select Dates -->
        <section id="step-1" class="bg-white p-5 rounded-2xl shadow-sm border border-stone-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="bg-kanam text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">1</span>
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs text-stone-500 mb-1">‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</label>
                    <input type="date" id="checkin" class="w-full p-2 border rounded-lg bg-stone-50">
                </div>
                <div>
                    <label class="block text-xs text-stone-500 mb-1">‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</label>
                    <input type="date" id="checkout" class="w-full p-2 border rounded-lg bg-stone-50">
                </div>
            </div>
            <button onclick="checkAvailability()" class="w-full mt-4 bg-stone-800 text-white py-3 rounded-xl font-bold active:scale-95 transition-transform">
                üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
            </button>
        </section>

        <!-- Step 2: Choose Rooms -->
        <section id="step-2" class="step-inactive bg-white p-5 rounded-2xl shadow-sm border border-stone-200">
            <h2 class="text-lg font-bold mb-2 flex items-center gap-2">
                <span class="bg-kanam text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">2</span>
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å
            </h2>
            <p class="text-xs text-stone-400 mb-4">* ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            
            <!-- Map Placeholder (Optional) -->
            <div id="map-container" class="relative bg-stone-100 w-full aspect-video rounded-xl border border-stone-200 mb-4 overflow-hidden">
                <img src="https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=1000&auto=format&fit=crop" class="w-full h-full object-cover opacity-40 grayscale">
                <div id="room-dots"></div>
            </div>

            <div id="room-list" class="space-y-3">
                <!-- Rooms injected here -->
            </div>
        </section>

        <!-- Step 3: Food & Summary -->
        <section id="step-3" class="step-inactive space-y-6">
            <!-- Foods -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-200">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span class="bg-kanam text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">3</span>
                    ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
                </h2>
                <div id="food-list" class="space-y-3"></div>
            </div>

            <!-- Booking Form -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-200">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span class="bg-kanam text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">4</span>
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á
                </h2>
                <div class="space-y-3 text-sm">
                    <div>
                        <label class="text-stone-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</label>
                        <input type="text" id="cust-name" class="w-full p-2 border rounded-lg" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                    </div>
                    <div>
                        <label class="text-stone-500">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="tel" id="cust-phone" class="w-full p-2 border rounded-lg" placeholder="08x-xxx-xxxx">
                    </div>
                    <div>
                        <label class="text-stone-500">‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <div class="flex gap-2">
                            <input type="text" id="promo-code" class="flex-1 p-2 border rounded-lg uppercase">
                            <button onclick="applyPromo()" class="bg-stone-200 px-4 rounded-lg">‡πÉ‡∏ä‡πâ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Card -->
            <div class="bg-kanam text-white p-6 rounded-3xl shadow-lg">
                <h3 class="text-lg font-bold mb-4 border-b border-white/20 pb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                <div id="summary-items" class="space-y-2 text-sm opacity-90"></div>
                <div class="mt-4 pt-4 border-t border-white/40 space-y-1">
                    <div class="flex justify-between text-sm">
                        <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                        <span id="sum-total">‡∏ø0</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-yellow-400">
                        <span>‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
                        <span id="sum-deposit">‡∏ø0</span>
                    </div>
                    <p class="text-[10px] text-white/60 mt-2">* ‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á/‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</p>
                </div>
            </div>

            <!-- Payment -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-200 text-center">
                <h2 class="text-lg font-bold mb-4">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</h2>
                <div class="flex flex-col items-center bg-stone-50 p-4 rounded-xl mb-4">
                    <img id="qr-code" src="" class="w-48 h-48 mb-2">
                    <p class="font-bold">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå: 061-592-4262</p>
                    <p class="text-sm">‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏•‡∏á‡∏Å‡∏ï ‡∏ó‡∏ß‡∏µ‡∏ú‡πà‡∏≠‡∏á</p>
                </div>
                <div class="text-left">
                    <label class="block text-sm font-bold mb-2">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</label>
                    <input type="file" id="slip-file" accept="image/*" class="w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-stone-800 file:text-white hover:file:bg-stone-700">
                </div>
                <button id="btn-submit" onclick="submitBooking()" class="w-full mt-6 bg-kanam text-white py-4 rounded-2xl font-bold shadow-lg hover:brightness-110 active:scale-95 transition-all">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                </button>
            </div>
        </section>
    </main>

    <!-- Navigation Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 z-[100] flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-kanam mx-auto mb-2"></div>
            <p class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbwQjaz5oaVekrtSlw_kGqt9gLOg0uQeXphG4H2Q5cqrv4ZSEiJnzO63lctvaaYTRr9HNQ/exec'; // ‡πÉ‡∏™‡πà URL ‡∏à‡∏≤‡∏Å Google Apps Script
        const LIFF_ID = '2008803474-hRJaVbm7'; // ‡πÉ‡∏™‡πà LIFF ID

        let masterData = { rooms: [], foods: [], promotions: [], specialDates: [] };
        let selectedRooms = [];
        let selectedFoods = {};
        let availability = { bookedRoomIDs: [], campOccupancy: {} };
        let userProfile = { lineID: '', lineName: '', displayName: '' };
        let appliedPromo = null;

        // --- Core Functions ---
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                userProfile.lineID = profile.userId;
                userProfile.displayName = profile.displayName;
                userProfile.lineName = profile.displayName; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á Backend

                document.getElementById('display-name').textContent = profile.displayName;
                const userImg = document.getElementById('user-img');
                userImg.src = profile.pictureUrl;
                userImg.classList.remove('hidden');

                await fetchData();
            } catch (err) {
                console.error("LIFF Init Error:", err);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        async function fetchData() {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'getInitialData' }) 
            });
            masterData = await res.json();
        }

        async function checkAvailability() {
            const cin = document.getElementById('checkin').value;
            const cout = document.getElementById('checkout').value;
            
            if (!cin || !cout) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå");
            if (new Date(cin) >= new Date(cout)) return alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô");

            document.getElementById('loading-overlay').classList.remove('hidden');
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'checkAvailability', checkIn: cin, checkOut: cout })
                });
                availability = await res.json();
                
                renderRooms();
                document.getElementById('step-2').classList.remove('step-inactive');
                window.scrollTo({ top: document.getElementById('step-2').offsetTop - 80, behavior: 'smooth' });
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function renderRooms() {
            const list = document.getElementById('room-list');
            const dots = document.getElementById('room-dots');
            list.innerHTML = '';
            dots.innerHTML = '';

            masterData.rooms.forEach(room => {
                const isBooked = availability.bookedRoomIDs.includes(room.id);
                const isSelected = selectedRooms.includes(room.id);
                
                // Dot on Map
                const dot = document.createElement('div');
                dot.className = `room-dot ${isBooked ? 'room-booked' : (isSelected ? 'room-selected' : 'room-available')}`;
                dot.style.left = room.coords.x + '%';
                dot.style.top = room.coords.y + '%';
                dot.innerText = room.id === 'CAMP' ? 'C' : room.id;
                dot.onclick = () => !isBooked && toggleRoom(room.id);
                dots.appendChild(dot);

                // List Item
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl border-2 transition-all ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-stone-100 bg-white'} ${isBooked ? 'opacity-50 grayscale' : 'cursor-pointer'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-stone-800">${room.name}</h3>
                            <p class="text-xs text-stone-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${room.maxPax} ‡∏ó‡πà‡∏≤‡∏ô</p>
                            <p class="text-sm font-bold text-kanam mt-1">‡∏ø${room.basePrice.toLocaleString()}/‡∏Ñ‡∏∑‡∏ô</p>
                        </div>
                        <div class="text-right">
                            ${isBooked ? '<span class="text-xs text-red-500 font-bold italic">‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á</span>' : (isSelected ? '‚úÖ' : '‚ûï')}
                        </div>
                    </div>
                `;
                card.onclick = () => !isBooked && toggleRoom(room.id);
                list.appendChild(card);
            });
        }

        function toggleRoom(roomId) {
            const index = selectedRooms.indexOf(roomId);
            if (index > -1) selectedRooms.splice(index, 1);
            else selectedRooms.push(roomId);
            
            renderRooms();
            if (selectedRooms.length > 0) {
                renderFoods();
                document.getElementById('step-3').classList.remove('step-inactive');
                updateSummary();
            } else {
                document.getElementById('step-3').classList.add('step-inactive');
            }
        }

        function renderFoods() {
            const list = document.getElementById('food-list');
            list.innerHTML = '';
            masterData.foods.forEach(food => {
                const qty = selectedFoods[food.id] || 0;
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-stone-50 p-3 rounded-xl";
                div.innerHTML = `
                    <div>
                        <p class="text-sm font-medium">${food.name}</p>
                        <p class="text-xs text-stone-400">‡∏ø${food.price.toLocaleString()}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="changeFoodQty('${food.id}', -1)" class="w-8 h-8 rounded-full bg-white border shadow-sm flex items-center justify-center">-</button>
                        <span class="w-4 text-center text-sm">${qty}</span>
                        <button onclick="changeFoodQty('${food.id}', 1)" class="w-8 h-8 rounded-full bg-white border shadow-sm flex items-center justify-center">+</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function changeFoodQty(id, delta) {
            let current = selectedFoods[id] || 0;
            current = Math.max(0, current + delta);
            if (current === 0) delete selectedFoods[id];
            else selectedFoods[id] = current;
            renderFoods();
            updateSummary();
        }

        function updateSummary() {
            const sumDiv = document.getElementById('summary-items');
            sumDiv.innerHTML = '';
            let total = 0;
            let totalDeposit = 0;

            const cin = new Date(document.getElementById('checkin').value);
            const cout = new Date(document.getElementById('checkout').value);
            const nights = Math.max(1, Math.round((cout - cin) / (1000 * 60 * 60 * 24)));

            // Rooms & Deposit Calculation
            selectedRooms.forEach(roomId => {
                const room = masterData.rooms.find(r => r.id === roomId);
                const roomTotal = room.basePrice * nights;
                total += roomTotal;

                // Check Special Deposit Rate
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Special Rate ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏° (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
                let rate = 50; // Default 50%
                const specialMatch = masterData.specialDates.find(sd => {
                    const sdDate = new Date(sd.date).toDateString();
                    const checkInDate = cin.toDateString();
                    return sdDate === checkInDate && (sd.roomID === 'ALL' || sd.roomID === roomId);
                });
                if (specialMatch) rate = specialMatch.depositRate;

                const roomDeposit = (roomTotal * rate) / 100;
                totalDeposit += roomDeposit;

                sumDiv.innerHTML += `
                    <div class="flex justify-between">
                        <span>${room.name} (${nights} ‡∏Ñ‡∏∑‡∏ô)</span>
                        <span>‡∏ø${roomTotal.toLocaleString()}</span>
                    </div>
                `;
            });

            // Foods
            Object.keys(selectedFoods).forEach(foodId => {
                const food = masterData.foods.find(f => f.id === foodId);
                const qty = selectedFoods[foodId];
                const foodTotal = food.price * qty;
                total += foodTotal;
                sumDiv.innerHTML += `
                    <div class="flex justify-between">
                        <span>${food.name} x${qty}</span>
                        <span>‡∏ø${foodTotal.toLocaleString()}</span>
                    </div>
                `;
            });

            // Promotion
            if (appliedPromo) {
                let discount = appliedPromo.type === 'Fixed' ? appliedPromo.value : (total * appliedPromo.value / 100);
                total = Math.max(0, total - discount);
                sumDiv.innerHTML += `
                    <div class="flex justify-between text-yellow-400">
                        <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (${appliedPromo.code})</span>
                        <span>-‡∏ø${discount.toLocaleString()}</span>
                    </div>
                `;
            }

            document.getElementById('sum-total').innerText = `‡∏ø${total.toLocaleString()}`;
            document.getElementById('sum-deposit').innerText = `‡∏ø${totalDeposit.toLocaleString()}`;
            
            // Update PromptPay QR
            const promptPayAmount = totalDeposit.toFixed(2);
            document.getElementById('qr-code').src = `https://promptpay.io/0615924262/${promptPayAmount}.png`;
        }

        function applyPromo() {
            const code = document.getElementById('promo-code').value.toUpperCase();
            const found = masterData.promotions.find(p => p.code === code);
            if (found) {
                appliedPromo = found;
                alert("‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                updateSummary();
            } else {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ô‡∏µ‡πâ");
            }
        }

        async function submitBooking() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            const slip = document.getElementById('slip-file').files[0];

            if (!name || !phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå");
            if (!slip) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");

            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerHTML = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...`;

            const reader = new FileReader();
            reader.readAsDataURL(slip);
            reader.onload = async () => {
                const finalDepositStr = document.getElementById('sum-deposit').innerText.replace('‡∏ø', '').replace(/,/g, '');
                const finalTotalStr = document.getElementById('sum-total').innerText.replace('‡∏ø', '').replace(/,/g, '');

                const payload = {
                    action: 'createBooking',
                    checkIn: document.getElementById('checkin').value,
                    checkOut: document.getElementById('checkout').value,
                    lineName: userProfile.lineName, // ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå N
                    customer: {
                        name: name,
                        phone: phone,
                        lineID: userProfile.lineID
                    },
                    rooms: selectedRooms.map(rid => ({
                        roomID: rid,
                        pax: masterData.rooms.find(mr => mr.id === rid).maxPax,
                        price: masterData.rooms.find(mr => mr.id === rid).basePrice
                    })),
                    foods: Object.keys(selectedFoods).map(fid => ({
                        foodID: fid,
                        qty: selectedFoods[fid],
                        price: masterData.foods.find(mf => mf.id === fid).price
                    })),
                    promoCode: appliedPromo ? appliedPromo.code : "",
                    totalPrice: Number(finalTotalStr),
                    deposit: Number(finalDepositStr),
                    slipBase64: reader.result
                };

                try {
                    const res = await fetch(API_URL, { 
                        method: 'POST', 
                        body: JSON.stringify(payload) 
                    });
                    const result = await res.json();
                    
                    if (result.status === 'success') {
                        alert("‚ú® ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á LINE ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
                        liff.closeWindow();
                    } else {
                        alert("‚ùå " + result.message);
                        btn.disabled = false;
                        btn.innerHTML = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á`;
                    }
                } catch (e) {
                    alert("‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
                    btn.disabled = false;
                    btn.innerHTML = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á`;
                }
            };
        }

        init();
    </script>
</body>
</html>
