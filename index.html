<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á - ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <script>
        function generatePromptPayPayload(phoneNumber, amount) {
            const target = phoneNumber.replace(/^0/, '66');
            const f01 = '00' + target; 
            const tag29Value = '0016A000000677010111' + '01' + String(f01.length).padStart(2,'0') + f01;
            const tag29 = '29' + String(tag29Value.length).padStart(2,'0') + tag29Value;
            const tag53 = '5303764';
            const amtStr = amount.toFixed(2);
            const tag54 = '54' + String(amtStr.length).padStart(2,'0') + amtStr;
            const tag58 = '5802TH';
            const data = '000201' + '010212' + tag29 + tag53 + tag54 + tag58 + '6304';
            let crc = 0xFFFF;
            for (let i = 0; i < data.length; i++) {
                let x = ((crc >> 8) ^ data.charCodeAt(i)) & 0xFF;
                x ^= x >> 4;
                crc = ((crc << 8) ^ (x << 12) ^ (x << 5) ^ x) & 0xFFFF;
            }
            return data + crc.toString(16).toUpperCase().padStart(4, '0');
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .map-container { position: relative; overflow: hidden; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .map-pin { position: absolute; transform: translate(-50%, -100%); cursor: pointer; transition: all 0.2s; }
        .map-pin:hover { transform: translate(-50%, -110%) scale(1.1); z-index: 10; }
        .map-pin.selected { border: 3px solid #fcd34d; z-index: 20; transform: translate(-50%, -110%) scale(1.1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQjaz5oaVekrtSlw_kGqt9gLOg0uQeXphG4H2Q5cqrv4ZSEiJnzO63lctvaaYTRr9HNQ/exec"; 
        const LIFF_ID = "2008803474-hRJaVbm7"; 
        const PROMPTPAY_PHONE = "0615924262";
        const PROMPTPAY_NAME = "‡∏≠‡∏•‡∏á‡∏Å‡∏ï ‡∏ó‡∏ß‡∏µ‡∏ú‡πà‡∏≠‡∏á";

        const DEFAULT_POSITIONS = { 'R1': {x: 20, y: 30}, 'R2': {x: 40, y: 50}, 'R3': {x: 60, y: 50}, 'T1': {x: 25, y: 70}, 'T2': {x: 35, y: 75}, 'K1': {x: 70, y: 70}, 'K2': {x: 80, y: 70}, 'Z8': {x: 50, y: 20} };
        
        // Base Room Data (Only Static Info)
        const BASE_ROOM_DATA = {
            'R1': { name: '‡πÇ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏¢‡πå‡∏´‡∏ô‡∏≥‡πÇ‡∏õ', tiers: [{max: 5, price: 1600}, {max: 8, price: 2200}], bf: false, type: 'room', desc: '‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡∏ç‡πà ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô', min: 1, maxCap: 8 },
            'R2': { name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 1', tiers: [{max: 2, price: 1400}, {max: 3, price: 1750}], bf: true, type: 'room', desc: '‡∏ß‡∏¥‡∏ß‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ', min: 1, maxCap: 3 },
            'R3': { name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 2', tiers: [{max: 2, price: 1400}, {max: 3, price: 1750}], bf: true, type: 'room', desc: '‡∏ß‡∏¥‡∏ß‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß', min: 1, maxCap: 3 },
            'T1': { name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 1', tiers: [{max: 2, price: 1200}, {max: 4, price: 1550}], bf: true, type: 'tent', desc: '‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏°‡∏™‡∏∏‡∏î‡∏Æ‡∏¥‡∏õ', min: 1, maxCap: 4 },
            'T2': { name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 2', tiers: [{max: 2, price: 1200}, {max: 4, price: 1550}], bf: true, type: 'tent', desc: '‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏ß‡∏¢', min: 1, maxCap: 4 },
            'K1': { name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K1', tiers: [{max: 2, price: 700}], bf: true, type: 'tent_rent', desc: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏ô', min: 1, maxCap: 2 },
            'K2': { name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K2', tiers: [{max: 2, price: 700}], bf: true, type: 'tent_rent', desc: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏ô', min: 1, maxCap: 2 },
            'Z8': { name: '‡∏•‡∏≤‡∏ô‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå', priceHead: 150, max: 20, bf: false, type: 'ground', desc: '‡∏ô‡∏≥‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏°‡∏≤‡πÄ‡∏≠‡∏á ‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏ô', min: 1, maxCap: 20 }
        };

        const App = () => {
            const [isDark, setIsDark] = React.useState(true);
            const [step, setStep] = React.useState(1);
            const [dates, setDates] = React.useState({ checkIn: '', checkOut: '' });
            const [availability, setAvailability] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [cart, setCart] = React.useState([]);
            const [customer, setCustomer] = React.useState({ name: '', phone: '', userId: '', lineDisplayName: '' });
            
            // Dynamic Data from Backend
            const [pinPos, setPinPos] = React.useState(DEFAULT_POSITIONS);
            const [systemSettings, setSystemSettings] = React.useState({ closed: [], special: [] });
            const [roomData, setRoomData] = React.useState(BASE_ROOM_DATA);
            const [foodMenu, setFoodMenu] = React.useState([]);

            const [discount, setDiscount] = React.useState({ code: '', val: 0, type: '', message: '', status: '' });
            const [slipImg, setSlipImg] = React.useState(null);
            const [bookingResult, setBookingResult] = React.useState(null);
            const [agreed, setAgreed] = React.useState(false);
            const [qrUrl, setQrUrl] = React.useState(null);
            
            const [selectedRoomId, setSelectedRoomId] = React.useState(null);
            const [guestCount, setGuestCount] = React.useState(1);
            const [selectedFood, setSelectedFood] = React.useState(null);
            const [foodCount, setFoodCount] = React.useState(1);
            const [closedModal, setClosedModal] = React.useState(null); 
            const [searchError, setSearchError] = React.useState(null);
            const [currentImgIdx, setCurrentImgIdx] = React.useState(0);

            // Fetch Initial Data
            React.useEffect(() => {
                if (LIFF_ID) liff.init({ liffId: LIFF_ID }).then(() => { if (liff.isLoggedIn()) liff.getProfile().then(p => setCustomer(prev => ({...prev, userId: p.userId, lineDisplayName: p.displayName}))); }).catch(console.error);
                
                fetch(`${GOOGLE_SCRIPT_URL}?action=getPublicData`)
                .then(r => r.json()).then(res => { 
                    if (res.status === 'success') {
                        setPinPos(res.mapData || DEFAULT_POSITIONS);
                        setSystemSettings({ closed: res.closed, special: res.special });
                        setFoodMenu(res.foodMenu);
                        
                        // Merge Images into Room Data
                        const updatedRooms = { ...BASE_ROOM_DATA };
                        Object.keys(updatedRooms).forEach(rid => {
                            updatedRooms[rid].images = res.roomImages[rid] || ["https://via.placeholder.com/400x300?text=No+Image"];
                        });
                        setRoomData(updatedRooms);
                    }
                }).catch(e => console.error(e));
            }, []);

            // ... (Logic Functions: getTommorow, formatThaiDate, getClosedDateOverlap, checkDateOverlapHighSeason, calculateNights, getPricing - Same as before)
            const getTommorow = () => { const d = new Date(); d.setDate(d.getDate() + 1); return d.toISOString().split('T')[0]; };
            const formatThaiDate = (dateStr) => { if(!dateStr) return "-"; const date = new Date(dateStr); const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."]; return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`; };
            const getClosedDateOverlap = (inDate, outDate) => { let current = new Date(inDate); const end = new Date(outDate); while(current < end) { const dStr = current.toISOString().split('T')[0]; const closed = systemSettings.closed.find(c => c.date === dStr); if (closed) return closed; current.setDate(current.getDate() + 1); } return null; };
            const checkDateOverlapHighSeason = (inDate, outDate) => { let current = new Date(inDate); const end = new Date(outDate); while(current < end) { const dStr = current.toISOString().split('T')[0]; if (systemSettings.special.some(s => s.date === dStr)) return true; current.setDate(current.getDate() + 1); } return false; };
            const calculateNights = () => { if(!dates.checkIn || !dates.checkOut) return 0; return (new Date(dates.checkOut) - new Date(dates.checkIn)) / (1000 * 3600 * 24); };
            const getPricing = () => {
                const nights = calculateNights(); let roomTotal = 0; let foodTotal = 0; let z8Total = 0;
                cart.forEach(item => { if (item.type === 'food') foodTotal += item.price * item.qty; else if (item.id === 'Z8') z8Total += item.pricePerNight * nights; else roomTotal += item.pricePerNight * nights; });
                let discountAmt = 0; if (discount.type === 'FIXED') discountAmt = discount.val; if (discount.type === 'PERCENT') discountAmt = (roomTotal * discount.val) / 100; if (discountAmt > roomTotal) discountAmt = roomTotal; 
                const totalBefore = roomTotal + z8Total + foodTotal; const netTotal = totalBefore - discountAmt;
                let deposit = 0; const isHigh = checkDateOverlapHighSeason(dates.checkIn, dates.checkOut);
                if (isHigh) deposit = netTotal; else { const roomDeposit = (roomTotal - discountAmt) * 0.5; deposit = roomDeposit + z8Total + foodTotal; }
                return { total: totalBefore, discount: discountAmt, netTotal: netTotal, deposit: Math.ceil(deposit), isHighSeason: isHigh };
            };
            const pricing = React.useMemo(() => getPricing(), [cart, dates, discount, systemSettings]);
            const canSubmit = customer.name && customer.phone && slipImg && agreed;

            React.useEffect(() => { if (step === 3 && pricing.deposit > 0) { const payload = generatePromptPayPayload(PROMPTPAY_PHONE, pricing.deposit); const qr = new QRious({ value: payload, size: 300 }); setQrUrl(qr.toDataURL()); } }, [step, pricing.deposit]);

            // Handlers
            const handleSearch = () => {
                if (!dates.checkIn || !dates.checkOut) { setSearchError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å'); return; }
                if (dates.checkIn >= dates.checkOut) { setSearchError('‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô'); return; }
                const closedFound = getClosedDateOverlap(dates.checkIn, dates.checkOut);
                if (closedFound) { setClosedModal(closedFound); return; }
                setLoading(true);
                fetch(`${GOOGLE_SCRIPT_URL}?action=getAvailability&checkIn=${dates.checkIn}&checkOut=${dates.checkOut}`).then(r => r.json()).then(data => { setAvailability(data); setStep(2); setLoading(false); }).catch(e => { alert('Error: ' + e); setLoading(false); });
            };
            const openRoomModal = (roomId) => { const room = roomData[roomId]; if(roomId === 'Z8') setGuestCount(1); else setGuestCount(room.min || 1); setCurrentImgIdx(0); setSelectedRoomId(roomId); };
            const confirmRoomSelection = () => {
                const roomId = selectedRoomId; const guests = guestCount; const roomInfo = roomData[roomId];
                if (roomId === 'Z8') { const currentZ8 = cart.filter(c => c.id === 'Z8').reduce((sum, c) => sum + c.guests, 0); if (currentZ8 + guests > availability.zone8Available) { alert(`‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏µ‡∏Å ${availability.zone8Available - currentZ8} ‡∏ó‡πà‡∏≤‡∏ô`); return; } }
                let price = 0; if (roomId === 'Z8') price = roomInfo.priceHead * guests; else { const tier = roomInfo.tiers.find(t => guests <= t.max); if (!tier) { alert('‡∏Ñ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î'); return; } price = tier.price; }
                setCart([...cart, { id: roomId, name: roomInfo.name, type: roomInfo.type, guests, pricePerNight: price, nights: calculateNights() }]); setSelectedRoomId(null);
            };
            const checkDiscountCode = () => { if(!discount.code) return; fetch(`${GOOGLE_SCRIPT_URL}?action=checkDiscount&code=${discount.code}`).then(r=>r.json()).then(d => { if(d.status === 'success') { setDiscount({...discount, val: parseInt(d.value), type: d.type, message: `‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, status: 'success'}); } else { setDiscount({...discount, val: 0, type: '', message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î', status: 'error'}); } }); };
            const handleSubmit = () => { if (!canSubmit) return; setLoading(true); const payload = { action: 'saveBooking', customer, checkIn: dates.checkIn, checkOut: dates.checkOut, totalGuests: cart.filter(c => c.type !== 'food').reduce((s, c) => s + c.guests, 0), cart, pricing, discountCode: discount.code, slipImage: slipImg }; fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json()).then(res => { if (res.status === 'success') { setBookingResult(res.bookingId); setStep(5); } else { alert('Error: ' + res.message); } setLoading(false); }).catch(e => { alert('Failed: ' + e); setLoading(false); }); };

            // Render
            return (
                <div className={isDark ? "dark" : ""}>
                    <div className="min-h-screen bg-[#f3f4f6] dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">
                        <button onClick={() => setIsDark(!isDark)} className="fixed top-4 right-4 z-50 bg-white dark:bg-gray-700 p-2 rounded-full shadow border">{isDark ? '‚òÄÔ∏è' : 'üåô'}</button>

                        {/* Step 1 */}
                        {step === 1 && (
                            <div className="max-w-md mx-auto bg-white dark:bg-gray-800 shadow-xl rounded-xl mt-4 border dark:border-gray-700 overflow-hidden">
                                <div className="h-48 relative"><img src="https://lh3.googleusercontent.com/pw/AP1GczPi_rYAbsNGi4X96mW5koYl0JJ3BN9ipRf6UgsXAOQgkyhrs2ChGcZlbsuQ3OLJOYnYhSTYJhWUuu2hwWtPqlt4MUfdUDSS3s4RdRLeD36gPLiK-8OhYLXWmqxVLh2eOtkLIx7pQxrQA6ZnqBYHOftH=w913-h913-s-no-gm?authuser=0" referrerPolicy="no-referrer" className="w-full h-full object-cover" /><div className="absolute inset-0 bg-black bg-opacity-10"></div></div>
                                <div className="p-6 -mt-24 relative z-10">
                                    <img src="https://lh3.googleusercontent.com/pw/AP1GczPi_rYAbsNGi4X96mW5koYl0JJ3BN9ipRf6UgsXAOQgkyhrs2ChGcZlbsuQ3OLJOYnYhSTYJhWUuu2hwWtPqlt4MUfdUDSS3s4RdRLeD36gPLiK-8OhYLXWmqxVLh2eOtkLIx7pQxrQA6ZnqBYHOftH=w913-h913-s-no-gm?authuser=0" referrerPolicy="no-referrer" className="w-48 h-48 mx-auto rounded-full border-4 border-white object-cover bg-white shadow-lg mb-4"/>
                                    <h1 className="text-xl text-center mb-2 font-bold dark:text-green-400">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ - Khanamlungdam</h1>
                                    <p className="text-center text-sm mb-4 dark:text-gray-300">‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏ß‡∏ô‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á ‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏∏‡∏ö‡πÄ‡∏Ç‡∏≤</p>
                                    <div className="space-y-4">
                                        <div><label className="block mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</label><input type="date" min={getTommorow()} className="w-full border p-2 rounded dark:bg-gray-700" onChange={e => setDates({...dates, checkIn: e.target.value})} /></div>
                                        <div><label className="block mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label><input type="date" min={dates.checkIn || getTommorow()} className="w-full border p-2 rounded dark:bg-gray-700" onChange={e => setDates({...dates, checkOut: e.target.value})} /></div>
                                        <button onClick={handleSearch} disabled={loading} className="w-full bg-green-600 text-white p-3 rounded-lg font-bold">{loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ß‡πà‡∏≤‡∏á'}</button>
                                    </div>
                                </div>
                                {closedModal && <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-6"><div className="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-sm text-center"><h3 className="text-xl font-bold mb-2">‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3><p className="mb-4 text-red-500">{closedModal.reason}</p><button onClick={() => setClosedModal(null)} className="bg-gray-800 text-white py-2 px-4 rounded-xl">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</button></div></div>}
                                {searchError && <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-6"><div className="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-sm text-center"><h3 className="text-xl font-bold mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3><p className="mb-4">{searchError}</p><button onClick={() => setSearchError(null)} className="bg-gray-800 text-white py-2 px-4 rounded-xl">‡∏ï‡∏Å‡∏•‡∏á</button></div></div>}
                            </div>
                        )}

                        {/* --- STEP 2 --- */}
                        {step === 2 && (
                            <div className="max-w-4xl mx-auto p-4 relative">
                                <div className="flex justify-between items-center mb-4"><button onClick={()=>setStep(1)} className="text-gray-500 font-bold"><i className="fas fa-chevron-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button><h2 className="text-xl font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</h2></div>
                                <div className="map-container bg-blue-100 dark:bg-gray-700 mb-6" style={{paddingBottom: '100%'}}>
                                    <img src="https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_68av0x68av0x68av.png" referrerpolicy="no-referrer" className="absolute top-0 left-0 w-full h-full object-cover" />
                                    {Object.keys(pinPos).map(key => {
                                        if (!roomData[key]) return null;
                                        const isBooked = availability.bookedRooms.includes(key);
                                        const inCart = cart.find(c => c.id === key);
                                        let circleClasses = "w-10 h-10 rounded-full flex items-center justify-center text-center text-[8px] font-bold border-2 shadow-lg p-1 leading-tight transition-all duration-300";
                                        if (isBooked || (key==='Z8'&&availability.zone8Available<=0)) circleClasses += " bg-gray-400 text-white cursor-not-allowed grayscale";
                                        else if (inCart) circleClasses += " bg-yellow-400 text-black border-yellow-600 scale-110 z-20";
                                        else circleClasses += " bg-white text-green-800 border-green-600 hover:scale-110 z-10";
                                        return (
                                            <div key={key} className="absolute transform -translate-x-1/2 -translate-y-1/2" style={{left: `${pinPos[key].x}%`, top: `${pinPos[key].y}%`}} onClick={() => { if(!isBooked && !(key==='Z8'&&availability.zone8Available<=0)) inCart ? setCart(cart.filter(c=>c.id!==key)) : openRoomModal(key); }}>
                                                <div className={circleClasses}><div>{roomData[key].name} {key==='Z8' && <div className="text-[9px]">({availability.zone8Available})</div>}</div></div>
                                            </div>
                                        )
                                    })}
                                </div>
                                {selectedRoomId && (
                                    <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm relative">
                                            <div className="relative w-full h-48 mb-4 rounded-lg overflow-hidden bg-gray-200">
                                                <img src={roomData[selectedRoomId].images[currentImgIdx]} className="w-full h-full object-cover" />
                                                <button onClick={()=>setCurrentImgIdx(p=>(p-1+roomData[selectedRoomId].images.length)%roomData[selectedRoomId].images.length)} className="absolute left-2 top-1/2 bg-black/50 text-white p-1 rounded-full"><i className="fas fa-chevron-left"></i></button>
                                                <button onClick={()=>setCurrentImgIdx(p=>(p+1)%roomData[selectedRoomId].images.length)} className="absolute right-2 top-1/2 bg-black/50 text-white p-1 rounded-full"><i className="fas fa-chevron-right"></i></button>
                                            </div>
                                            <h3 className="text-xl font-bold mb-2">{roomData[selectedRoomId].name}</h3>
                                            <p className="text-sm mb-4">{roomData[selectedRoomId].desc}</p>
                                            <div className="flex items-center justify-between mb-6 bg-gray-100 dark:bg-gray-700 p-3 rounded">
                                                <button onClick={() => setGuestCount(Math.max((roomData[selectedRoomId].min||1), guestCount - 1))} className="w-8 h-8 bg-white rounded shadow">-</button>
                                                <div className="text-xl font-bold">{guestCount} ‡∏Ñ‡∏ô</div>
                                                <button onClick={() => setGuestCount(Math.min(selectedRoomId==='Z8'?availability.zone8Available:roomData[selectedRoomId].maxCap, guestCount + 1))} className="w-8 h-8 bg-white rounded shadow">+</button>
                                            </div>
                                            <div className="flex gap-2"><button onClick={() => setSelectedRoomId(null)} className="flex-1 py-2 bg-gray-200 text-gray-800 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onClick={confirmRoomSelection} className="flex-1 py-2 bg-green-600 text-white rounded">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
                                        </div>
                                    </div>
                                )}
                                <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-4">
                                    <h3 className="font-bold mb-4">üçΩÔ∏è ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        {foodMenu.map(f => {
                                            const inCart = cart.find(c => c.id === f.id);
                                            return (
                                                <div key={f.id} onClick={() => { if(inCart) setCart(cart.filter(c => c.id !== f.id)); else { setSelectedFood(f); setFoodCount(1); } }} className={`cursor-pointer rounded-lg overflow-hidden border-2 relative ${inCart ? 'border-yellow-500 bg-yellow-50' : 'border-gray-200'}`}>
                                                    <img src={f.img} className="w-full h-24 object-cover" />
                                                    <div className="p-2"><h4 className="font-bold text-sm truncate">{f.name}</h4><div className="text-green-600 font-bold">{f.price}.-</div></div>
                                                    {inCart && <div className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex justify-center items-center text-xs">x</div>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                {selectedFood && (
                                    <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                                        <div className="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm">
                                            <img src={selectedFood.img} className="w-full h-40 object-cover rounded mb-4"/>
                                            <h3 className="text-xl font-bold">{selectedFood.name}</h3>
                                            <div className="flex justify-center gap-4 my-4 items-center">
                                                <button onClick={()=>setFoodCount(Math.max(1,foodCount-1))} className="w-8 h-8 bg-gray-200 rounded">-</button>
                                                <span className="text-xl font-bold">{foodCount}</span>
                                                <button onClick={()=>setFoodCount(foodCount+1)} className="w-8 h-8 bg-gray-200 rounded">+</button>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={()=>setSelectedFood(null)} className="flex-1 py-2 bg-gray-200 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                                <button onClick={()=>{
                                                    const exist = cart.find(c=>c.id===selectedFood.id);
                                                    if(exist) setCart(cart.map(c=>c.id===selectedFood.id?{...c,qty:c.qty+foodCount}:c)); else setCart([...cart,{...selectedFood,type:'food',qty:foodCount}]);
                                                    setSelectedFood(null);
                                                }} className="flex-1 py-2 bg-green-600 text-white rounded">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div className="bg-gray-100 dark:bg-gray-700 p-4 rounded mb-4"><h3 className="font-bold">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ({cart.length})</h3>{cart.map((c,i)=><div key={i} className="flex justify-between text-sm mt-1"><span>{c.name} {c.type==='food'?`x${c.qty}`:`(${c.guests} ‡∏Ñ‡∏ô)`}</span><button onClick={()=>setCart(cart.filter((_,idx)=>idx!==i))} className="text-red-500">‡∏•‡∏ö</button></div>)}</div>
                                <button onClick={() => cart.length > 0 ? setStep(3) : alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö')} className="w-full bg-green-600 text-white p-3 rounded-lg font-bold">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</button>
                            </div>
                        )}

                        {/* --- STEP 3 --- */}
                        {step === 3 && (
                            <div className="max-w-md mx-auto p-6 bg-white dark:bg-gray-800 shadow-xl rounded-xl">
                                <div className="flex items-center gap-2 mb-4"><button onClick={()=>setStep(2)} className="text-gray-500 font-bold"><i className="fas fa-chevron-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button><h2 className="text-xl font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</h2></div>
                                <div className="space-y-2 mb-4 text-sm">
                                    <p><strong>‡πÄ‡∏Ç‡πâ‡∏≤:</strong> {formatThaiDate(dates.checkIn)} <strong>‡∏≠‡∏≠‡∏Å:</strong> {formatThaiDate(dates.checkOut)} ({calculateNights()} ‡∏Ñ‡∏∑‡∏ô)</p>
                                    <hr className="dark:border-gray-600"/>
                                    {cart.map((c, i) => <div key={i} className="flex justify-between"><span>{c.name}</span><span>{c.type==='food' ? c.price*c.qty : c.pricePerNight*calculateNights()} ‡∏ö.</span></div>)}
                                    <hr className="dark:border-gray-600"/>
                                    {pricing.discount > 0 && <div className="flex justify-between text-red-500"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span><span>-{pricing.discount}</span></div>}
                                    <div className="flex justify-between font-bold text-lg"><span>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span>{pricing.netTotal} ‡∏ö.</span></div>
                                    <div className="bg-yellow-100 p-2 rounded text-center border border-yellow-300 mt-2"><span className="block text-sm text-yellow-800">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥</span><span className="text-2xl font-bold text-red-600">{pricing.deposit} ‡∏ö‡∏≤‡∏ó</span></div>
                                </div>
                                <div className="mb-4 flex gap-2"><input placeholder="‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" className="border p-2 rounded flex-1 dark:bg-gray-700" onChange={e=>setDiscount({...discount,code:e.target.value})}/><button className="bg-gray-800 text-white px-4 rounded" onClick={checkDiscountCode}>‡πÉ‡∏ä‡πâ</button></div>
                                {discount.message && <p className={`text-xs mb-4 ${discount.status==='success'?'text-green-500':'text-red-500'}`}>{discount.message}</p>}
                                <div className="space-y-3 mb-6"><input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" className="w-full border p-2 rounded dark:bg-gray-700" value={customer.name} onChange={e=>setCustomer({...customer,name:e.target.value})}/><input placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" className="w-full border p-2 rounded dark:bg-gray-700" type="tel" value={customer.phone} onChange={e=>setCustomer({...customer,phone:e.target.value})}/></div>
                                <div className="text-center mb-6"><p className="mb-2 font-bold">‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏±‡∏î‡∏à‡∏≥</p>{qrUrl ? <div className="flex flex-col items-center"><img src={qrUrl} className="mx-auto border-2 rounded mb-3 bg-white" width="200"/><a href={qrUrl} download="qr.png" className="bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-xs font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ</a></div> : <div>Creating QR...</div>}<div className="mt-4"><p className="text-sm font-bold">{PROMPTPAY_NAME}</p><p className="text-xs">{PROMPTPAY_PHONE}</p></div></div>
                                <div className="mb-4"><label className="block mb-1 text-sm">‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô *</label><input type="file" accept="image/*" onChange={e=>{const f=e.target.files[0]; const r=new FileReader(); r.onloadend=()=>setSlipImg(r.result); r.readAsDataURL(f);}} className="w-full text-sm"/></div>
                                <div className="flex items-start gap-2 mb-4 text-xs"><input type="checkbox" className="mt-1" checked={agreed} onChange={e=>setAgreed(e.target.checked)}/><p>‡∏â‡∏±‡∏ô‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p></div>
                                <button onClick={handleSubmit} disabled={loading||!canSubmit} className="w-full p-3 rounded-lg font-bold text-white bg-green-600">{loading?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...':'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á'}</button>
                            </div>
                        )}

                        {/* --- STEP 5 --- */}
                        {step === 5 && (
                            <div className="max-w-md mx-auto p-10 text-center bg-white dark:bg-gray-800 shadow-xl rounded-xl mt-10">
                                <div className="text-6xl mb-4">üéâ</div>
                                <h2 className="text-2xl font-bold text-green-600 mb-2">‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                                <p className="mb-4">‡∏£‡∏´‡∏±‡∏™: <strong>{bookingResult}</strong></p>
                                <p className="text-sm text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏à‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á LINE ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö</p>
                                <button onClick={() => liff.closeWindow()} className="mt-8 bg-gray-800 text-white px-6 py-2 rounded-full">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
