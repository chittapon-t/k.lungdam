<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จองที่พักขนำลุงดำ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kld: {
                            green: '#2F4F4F',
                            brown: '#8B4513',
                            cream: '#F5F5DC',
                            light: '#FAF9F6'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .map-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Aspect Ratio Square-ish */
            background-color: #e2e8f0;
            background-image: url('https://placehold.co/800x800/2F4F4F/FFFFFF?text=Map+Layout+Plan'); /* Replace with Real Map */
            background-size: cover;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .hotspot {
            position: absolute;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
            border: 2px solid white;
            border-radius: 50%;
        }
        .hotspot.free { background-color: rgba(34, 197, 94, 0.6); }
        .hotspot.occupied { background-color: rgba(239, 68, 68, 0.8); cursor: not-allowed; pointer-events: none; }
        .hotspot.selected { background-color: rgba(234, 179, 8, 0.9); transform: scale(1.1); border-color: #2F4F4F; }
        
        /* Define Positions (Example based on logic) */
        #spot-NP { top: 30%; left: 30%; width: 15%; height: 15%; }
        #spot-RN1 { top: 40%; left: 15%; width: 10%; height: 10%; }
        #spot-RN2 { top: 50%; left: 15%; width: 10%; height: 10%; }
        #spot-CAMP { top: 60%; left: 50%; width: 20%; height: 15%; border-radius: 10px; }
        /* Add other rooms... */
    </style>
</head>
<body class="bg-kld-light text-gray-800 font-sans">

    <!-- Navbar -->
    <nav class="bg-kld-green text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold">ขนำลุงดำ</h1>
            <div id="user-info" class="text-sm">Guest</div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mx-auto p-4 max-w-md pb-24">

        <!-- Step 1: Date Selection -->
        <div class="bg-white p-4 rounded-lg shadow mb-4">
            <h2 class="text-lg font-bold text-kld-brown mb-2">1. เลือกวันที่เข้าพัก</h2>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="text-xs text-gray-500">Check-in</label>
                    <input type="date" id="checkInDate" class="w-full border p-2 rounded bg-gray-50">
                </div>
                <div>
                    <label class="text-xs text-gray-500">Check-out</label>
                    <input type="date" id="checkOutDate" class="w-full border p-2 rounded bg-gray-50">
                </div>
            </div>
            <button onclick="checkAvailability()" class="mt-3 w-full bg-kld-brown text-white py-2 rounded hover:bg-opacity-90">ตรวจสอบห้องว่าง</button>
        </div>

        <!-- Step 2: Map Selection -->
        <div id="map-section" class="hidden mb-4">
            <h2 class="text-lg font-bold text-kld-brown mb-2">2. เลือกห้องพักจากแผนที่</h2>
            <div class="map-container relative">
                <!-- Hotspots generated by JS -->
                <div id="spot-NP" class="hotspot free" onclick="toggleRoom('NP', 'หนำโป', 1600)">NP</div>
                <div id="spot-RN1" class="hotspot free" onclick="toggleRoom('RN1', 'ริมน้ำ 1', 1400)">RN1</div>
                <div id="spot-RN2" class="hotspot free" onclick="toggleRoom('RN2', 'ริมน้ำ 2', 1400)">RN2</div>
                <div id="spot-CAMP" class="hotspot free" onclick="toggleRoom('CAMP', 'ลานกางเต็นท์', 150)">
                    CAMP <span id="camp-left" class="text-xs block ml-1">(20)</span>
                </div>
            </div>
            <div class="mt-2 text-sm text-gray-600 flex gap-2">
                <span class="flex items-center"><div class="w-3 h-3 bg-green-500 rounded-full mr-1"></div> ว่าง</span>
                <span class="flex items-center"><div class="w-3 h-3 bg-red-500 rounded-full mr-1"></div> เต็ม</span>
                <span class="flex items-center"><div class="w-3 h-3 bg-yellow-400 rounded-full mr-1"></div> เลือก</span>
            </div>
        </div>

        <!-- Step 3: Booking Details & Food -->
        <div id="details-section" class="hidden bg-white p-4 rounded-lg shadow mb-4">
            <h2 class="text-lg font-bold text-kld-brown mb-2">3. รายละเอียด & อาหาร</h2>
            <div id="selected-rooms-list" class="mb-4 space-y-2"></div>
            
            <hr class="my-2">
            <h3 class="font-bold mb-2">สั่งอาหารล่วงหน้า</h3>
            <div class="flex justify-between items-center mb-2">
                <span>หมูกระทะ (390.-)</span>
                <input type="number" min="0" value="0" id="food-F1" class="border w-16 p-1 rounded text-center" onchange="calculateTotal()">
            </div>
            <div class="flex justify-between items-center mb-2">
                <span>ไก่กระทะ (390.-)</span>
                <input type="number" min="0" value="0" id="food-F2" class="border w-16 p-1 rounded text-center" onchange="calculateTotal()">
            </div>
        </div>

        <!-- Step 4: User Info & Payment -->
        <div id="payment-section" class="hidden bg-white p-4 rounded-lg shadow mb-4">
            <h2 class="text-lg font-bold text-kld-brown mb-2">4. ข้อมูลผู้จอง & ชำระเงิน</h2>
            <input type="text" id="custName" placeholder="ชื่อผู้จอง" class="w-full border p-2 rounded mb-2">
            <input type="tel" id="custPhone" placeholder="เบอร์โทรศัพท์" class="w-full border p-2 rounded mb-2">
            
            <div class="bg-gray-100 p-3 rounded mt-2">
                <div class="flex justify-between"><span>ค่าที่พัก</span><span id="sum-room">0</span></div>
                <div class="flex justify-between"><span>ค่าอาหาร</span><span id="sum-food">0</span></div>
                <div class="flex justify-between font-bold text-lg mt-2 text-kld-green">
                    <span>ยอดรวม</span><span id="sum-total">0</span>
                </div>
                <div class="flex justify-between font-bold text-red-600">
                    <span>มัดจำที่ต้องโอน (50% + อาหาร)</span><span id="sum-deposit">0</span>
                </div>
            </div>

            <div class="mt-4 text-center">
                <p class="mb-2">สแกน QR เพื่อชำระมัดจำ</p>
                <img id="qr-code" src="" class="mx-auto w-48 h-48 border rounded shadow" alt="QR Code">
                <p class="text-sm mt-1">0615924262 อลงกต ทวีผ่อง</p>
            </div>

            <div class="mt-4">
                <label class="block mb-2 text-sm font-medium text-gray-900">อัปโหลดสลิปโอนเงิน</label>
                <input type="file" id="slipFile" accept="image/*" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
            </div>

            <button onclick="submitBooking()" class="mt-6 w-full bg-kld-green text-white py-3 rounded-lg font-bold shadow-lg hover:bg-opacity-90">ยืนยันการจอง</button>
        </div>

    </div>

    <script>
        // CONFIG
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQjaz5oaVekrtSlw_kGqt9gLOg0uQeXphG4H2Q5cqrv4ZSEiJnzO63lctvaaYTRr9HNQ/exec"; 
        let liffId = "2008803474-hRJaVbm7";
        
        // STATE
        let state = {
            profile: null,
            selectedRooms: {}, // id: { name, price, pax }
            checkIn: '',
            checkOut: '',
            availableData: null
        };

        // INIT
        window.onload = async () => {
            // Set Default Dates (Tomorrow)
            const tmr = new Date(); tmr.setDate(tmr.getDate() + 1);
            const tmr2 = new Date(); tmr2.setDate(tmr.getDate() + 1);
            document.getElementById('checkInDate').valueAsDate = tmr;
            document.getElementById('checkOutDate').valueAsDate = tmr2;

            await initLiff();
        };

        async function initLiff() {
            try {
                await liff.init({ liffId: liffId });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    state.profile = profile;
                    document.getElementById('user-info').innerText = profile.displayName;
                    document.getElementById('custName').value = profile.displayName;
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function checkAvailability() {
            const cin = document.getElementById('checkInDate').value;
            const cout = document.getElementById('checkOutDate').value;

            if(!cin || !cout) return Swal.fire('แจ้งเตือน', 'กรุณาเลือกวันที่', 'warning');

            state.checkIn = cin;
            state.checkOut = cout;

            Swal.fire({ title: 'กำลังตรวจสอบ...', didOpen: () => Swal.showLoading() });

            // Call GAS
            try {
                const res = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'checkAvailability', checkIn: cin, checkOut: cout })
                });
                const json = await res.json();
                
                if(json.status === 'success') {
                    renderMap(json.data);
                    document.getElementById('map-section').classList.remove('hidden');
                    Swal.close();
                } else {
                    throw new Error(json.message);
                }
            } catch (e) {
                Swal.fire('Error', 'ไม่สามารถเชื่อมต่อระบบได้', 'error');
            }
        }

        function renderMap(data) {
            // Reset selection
            state.selectedRooms = {};
            calculateTotal();
            
            // Loop all hotspots
            document.querySelectorAll('.hotspot').forEach(el => {
                el.classList.remove('occupied', 'selected', 'free');
                el.classList.add('free'); // Default
                
                const id = el.id.replace('spot-', '');
                
                // Logic for Occupied
                if (data.occupied.includes(id)) {
                    el.classList.remove('free');
                    el.classList.add('occupied');
                }

                // Logic for Camp
                if (id === 'CAMP') {
                    document.getElementById('camp-left').innerText = `(${data.campAvailable})`;
                    if(data.campAvailable <= 0) {
                        el.classList.remove('free');
                        el.classList.add('occupied');
                    }
                }
            });
        }

        window.toggleRoom = (id, name, price) => {
            const el = document.getElementById(`spot-${id}`);
            if(el.classList.contains('occupied')) return;

            if(state.selectedRooms[id]) {
                // Deselect
                delete state.selectedRooms[id];
                el.classList.remove('selected');
            } else {
                // Select
                state.selectedRooms[id] = { name, price, pax: 2 }; // Default pax 2
                el.classList.add('selected');
            }
            
            renderDetails();
        };

        function renderDetails() {
            const container = document.getElementById('selected-rooms-list');
            container.innerHTML = '';
            
            const ids = Object.keys(state.selectedRooms);
            if(ids.length > 0) {
                document.getElementById('details-section').classList.remove('hidden');
                document.getElementById('payment-section').classList.remove('hidden');
            } else {
                document.getElementById('details-section').classList.add('hidden');
                document.getElementById('payment-section').classList.add('hidden');
            }

            ids.forEach(id => {
                const room = state.selectedRooms[id];
                const html = `
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded border">
                        <div>
                            <span class="font-bold text-kld-green">${room.name}</span>
                            <div class="text-xs text-gray-500">${room.price} บาท/คืน</div>
                        </div>
                        <div class="flex items-center">
                            <label class="text-xs mr-2">จำนวนคน:</label>
                            <input type="number" min="1" max="10" value="${room.pax}" 
                                class="border w-12 text-center rounded"
                                onchange="updatePax('${id}', this.value)">
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            calculateTotal();
        }

        window.updatePax = (id, val) => {
            if(state.selectedRooms[id]) {
                state.selectedRooms[id].pax = parseInt(val);
                // Note: Real logic needs to re-calculate price based on pax tiered pricing
                calculateTotal();
            }
        };

        function calculateTotal() {
            let roomTotal = 0;
            Object.values(state.selectedRooms).forEach(r => {
                // Simple logic: Base Price. 
                // In production, add logic: if (r.pax > threshold) price = price2
                roomTotal += r.price; 
            });

            const f1 = parseInt(document.getElementById('food-F1').value) * 390;
            const f2 = parseInt(document.getElementById('food-F2').value) * 390;
            const foodTotal = f1 + f2;

            const total = roomTotal + foodTotal;
            const deposit = (roomTotal * 0.5) + foodTotal; // 50% room + 100% food

            document.getElementById('sum-room').innerText = roomTotal.toLocaleString();
            document.getElementById('sum-food').innerText = foodTotal.toLocaleString();
            document.getElementById('sum-total').innerText = total.toLocaleString();
            document.getElementById('sum-deposit').innerText = deposit.toLocaleString();

            // Generate PromptPay QR
            const ppUrl = `https://promptpay.io/0615924262/${deposit}.png`;
            document.getElementById('qr-code').src = ppUrl;
        }

        window.submitBooking = async () => {
            const name = document.getElementById('custName').value;
            const phone = document.getElementById('custPhone').value;
            const fileInput = document.getElementById('slipFile');

            if(!name || !phone || fileInput.files.length === 0) {
                return Swal.fire('ข้อมูลไม่ครบ', 'กรุณากรอกชื่อ เบอร์โทร และแนบสลิป', 'warning');
            }

            // Convert Image to Base64
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result;

                Swal.fire({ title: 'กำลังบันทึกการจอง...', didOpen: () => Swal.showLoading() });

                const payload = {
                    action: 'createBooking',
                    userId: state.profile ? state.profile.userId : 'GUEST',
                    name, phone,
                    checkIn: state.checkIn,
                    checkOut: state.checkOut,
                    rooms: Object.keys(state.selectedRooms).map(k => ({ id: k, pax: state.selectedRooms[k].pax })),
                    foods: [
                        { id: 'F1', qty: parseInt(document.getElementById('food-F1').value), price: 390 },
                        { id: 'F2', qty: parseInt(document.getElementById('food-F2').value), price: 390 }
                    ].filter(f => f.qty > 0),
                    totalPrice: parseFloat(document.getElementById('sum-total').innerText.replace(/,/g, '')),
                    deposit: parseFloat(document.getElementById('sum-deposit').innerText.replace(/,/g, '')),
                    slipImage: base64
                };

                try {
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const json = await res.json();
                    if(json.status === 'success') {
                        Swal.fire('สำเร็จ', `การจองเรียบร้อย Booking ID: ${json.data.bookingId}`, 'success')
                        .then(() => liff.closeWindow());
                    } else {
                        throw new Error(json.message);
                    }
                } catch (e) {
                    Swal.fire('เกิดข้อผิดพลาด', e.message, 'error');
                }
            };
        };

    </script>
</body>
</html>
