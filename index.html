<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á - ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LIFF SDK (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <!-- PromptPay Library Helper -->
    <script>
        function generatePromptPayPayload(phoneNumber, amount) {
            const pAmount = amount.toFixed(2);
            const target = "0016A00000067701011101130066" + phoneNumber.replace(/^0/, '66');
            let data = ["0002010102122937", target, "5802TH530376454", pAmount.length < 10 ? "0" + pAmount.length : pAmount.length, pAmount, "6304"];
            let str = data.join("");
            function crc16(s) {
                let crc = 0xFFFF;
                for (let i = 0; i < s.length; i++) {
                    let x = ((crc >> 8) ^ s.charCodeAt(i)) & 0xFF;
                    x ^= x >> 4;
                    crc = ((crc << 8) ^ (x << 12) ^ (x << 5) ^ x) & 0xFFFF;
                }
                return crc.toString(16).toUpperCase().padStart(4, '0');
            }
            return str + crc16(str);
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
        .map-container { position: relative; overflow: hidden; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .map-pin { position: absolute; transform: translate(-50%, -100%); cursor: pointer; transition: all 0.2s; }
        .map-pin:hover { transform: translate(-50%, -110%) scale(1.1); z-index: 10; }
        .map-pin.selected { border: 3px solid #fcd34d; z-index: 20; transform: translate(-50%, -110%) scale(1.1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQjaz5oaVekrtSlw_kGqt9gLOg0uQeXphG4H2Q5cqrv4ZSEiJnzO63lctvaaYTRr9HNQ/exec"; 
        const LIFF_ID = "2008803474-hRJaVbm7"; // ‡∏™‡∏£‡πâ‡∏≤‡∏á LIFF ‡πÉ‡∏ô LINE Developers ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥ ID ‡∏°‡∏≤‡πÉ‡∏™‡πà
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å & ‡∏£‡∏≤‡∏Ñ‡∏≤
        const ROOM_DATA = {
            'R1': { name: '‡πÇ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏¢‡πå‡∏´‡∏ô‡∏≥‡πÇ‡∏õ', tiers: [{max: 5, price: 1600}, {max: 8, price: 2200}], bf: false, type: 'room', desc: '‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡∏ç‡πà ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô' },
            'R2': { name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 1', tiers: [{max: 2, price: 1400}, {max: 3, price: 1750}], bf: true, type: 'room', desc: '‡∏ß‡∏¥‡∏ß‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ' },
            'R3': { name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 2', tiers: [{max: 2, price: 1400}, {max: 3, price: 1750}], bf: true, type: 'room', desc: '‡∏ß‡∏¥‡∏ß‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' },
            'T1': { name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 1', tiers: [{max: 2, price: 1200}, {max: 4, price: 1550}], bf: true, type: 'tent', desc: '‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏°‡∏™‡∏∏‡∏î‡∏Æ‡∏¥‡∏õ' },
            'T2': { name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 2', tiers: [{max: 2, price: 1200}, {max: 4, price: 1550}], bf: true, type: 'tent', desc: '‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏ß‡∏¢' },
            'K1': { name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K1', tiers: [{max: 2, price: 700}], bf: true, type: 'tent_rent', desc: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏ô' },
            'K2': { name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K2', tiers: [{max: 2, price: 700}], bf: true, type: 'tent_rent', desc: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏ô' },
            'Z8': { name: '‡∏•‡∏≤‡∏ô‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå', priceHead: 150, max: 20, bf: false, type: 'ground', desc: '‡∏ô‡∏≥‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏°‡∏≤‡πÄ‡∏≠‡∏á ‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏ô' }
        };

        const FOOD_MENU = [
            { id: 'F1', name: '‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'F2', name: '‡∏ä‡∏∏‡∏î‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'F3', name: '‡∏ä‡∏∏‡∏î‡∏ä‡∏≤‡∏ö‡∏π‡∏´‡∏°‡∏π‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'F4', name: '‡∏ä‡∏∏‡∏î‡∏ä‡∏≤‡∏ö‡∏π‡πÑ‡∏Å‡πà‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'F5', name: '‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', price: 390 }
        ];

        const HIGH_SEASON = ['2025-12-30', '2025-12-31', '2026-01-01', '2026-01-02'];

        const INITIAL_POSITIONS = {
            'R1': {x: 20, y: 30}, 'R2': {x: 40, y: 50}, 'R3': {x: 60, y: 50},
            'T1': {x: 25, y: 70}, 'T2': {x: 35, y: 75}, 'K1': {x: 70, y: 70},
            'K2': {x: 80, y: 70}, 'Z8': {x: 50, y: 20}
        };

        const App = () => {
            const [step, setStep] = React.useState(1);
            const [dates, setDates] = React.useState({ checkIn: '', checkOut: '' });
            const [availability, setAvailability] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [cart, setCart] = React.useState([]);
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° lineDisplayName ‡πÉ‡∏ô State
            const [customer, setCustomer] = React.useState({ name: '', phone: '', userId: '', lineDisplayName: '' });
            const [devMode, setDevMode] = React.useState(false);
            const [pinPos, setPinPos] = React.useState(INITIAL_POSITIONS);
            const [discount, setDiscount] = React.useState({ code: '', val: 0, type: '' });
            const [slipImg, setSlipImg] = React.useState(null);
            const [bookingResult, setBookingResult] = React.useState(null);
            const [agreed, setAgreed] = React.useState(false);
            const [liffError, setLiffError] = React.useState(null);

            // --- LIFF INITIALIZATION ---
            React.useEffect(() => {
                if (LIFF_ID) {
                    liff.init({ liffId: LIFF_ID })
                        .then(() => {
                            if (liff.isLoggedIn()) {
                                liff.getProfile().then(profile => {
                                    setCustomer(prev => ({
                                        ...prev,
                                        name: profile.displayName, // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)
                                        userId: profile.userId,
                                        lineDisplayName: profile.displayName // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏¢‡∏Å‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
                                    }));
                                });
                            } else {
                                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô External Browser
                                if (!liff.isInClient()) {
                                    // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞ Show ‡∏õ‡∏∏‡πà‡∏° Login
                                }
                            }
                        })
                        .catch((err) => {
                            console.error('LIFF Init Error', err);
                            setLiffError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ (‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)');
                        });
                }
            }, []);

            const loginLine = () => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            };

            // Helpers
            const getTommorow = () => {
                const d = new Date(); d.setDate(d.getDate() + 1);
                return d.toISOString().split('T')[0];
            };

            const isHighSeason = (dStr) => HIGH_SEASON.includes(dStr);
            
            const checkDateOverlapHighSeason = (inDate, outDate) => {
                let current = new Date(inDate);
                const end = new Date(outDate);
                while(current < end) {
                    if (isHighSeason(current.toISOString().split('T')[0])) return true;
                    current.setDate(current.getDate() + 1);
                }
                return false;
            };

            const calculateNights = () => {
                if(!dates.checkIn || !dates.checkOut) return 0;
                return (new Date(dates.checkOut) - new Date(dates.checkIn)) / (1000 * 3600 * 24);
            }

            // Step 1: Search
            const handleSearch = () => {
                if (!dates.checkIn || !dates.checkOut) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å');
                if (dates.checkIn >= dates.checkOut) return alert('‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô');
                
                setLoading(true);
                fetch(`${GOOGLE_SCRIPT_URL}?action=getAvailability&checkIn=${dates.checkIn}&checkOut=${dates.checkOut}`)
                    .then(r => r.json())
                    .then(data => {
                        setAvailability(data);
                        setStep(2);
                        setLoading(false);
                    })
                    .catch(e => {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + e);
                        setLoading(false);
                    });
            };

            // Step 2: Add to Cart
            const addToCart = (roomId, guests) => {
                if (roomId !== 'Z8' && cart.find(x => x.id === roomId)) return alert('‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
                
                const roomInfo = ROOM_DATA[roomId];
                let price = 0;
                
                if (roomId === 'Z8') {
                     const currentZ8 = cart.filter(c => c.id === 'Z8').reduce((sum, c) => sum + c.guests, 0);
                     if (currentZ8 + guests > availability.zone8Available) return alert(`‡∏•‡∏≤‡∏ô‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏µ‡∏Å ${availability.zone8Available - currentZ8} ‡∏ó‡πà‡∏≤‡∏ô`);
                     price = roomInfo.priceHead * guests;
                } else {
                    const tier = roomInfo.tiers.find(t => guests <= t.max);
                    if (!tier) return alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î');
                    price = tier.price;
                }

                setCart([...cart, { 
                    id: roomId, 
                    name: roomInfo.name, 
                    type: roomInfo.type, 
                    guests, 
                    pricePerNight: price,
                    nights: calculateNights()
                }]);
            };

            const addFood = (food) => {
                const exist = cart.find(c => c.id === food.id);
                if (exist) {
                    setCart(cart.map(c => c.id === food.id ? {...c, qty: c.qty + 1} : c));
                } else {
                    setCart([...cart, { ...food, type: 'food', qty: 1 }]);
                }
            };

            // Calculation
            const getPricing = () => {
                const nights = calculateNights();
                let roomTotal = 0;
                let foodTotal = 0;
                let z8Total = 0;

                cart.forEach(item => {
                    if (item.type === 'food') {
                        foodTotal += item.price * item.qty;
                    } else if (item.id === 'Z8') {
                        z8Total += item.pricePerNight * nights;
                    } else {
                        roomTotal += item.pricePerNight * nights;
                    }
                });

                let discountAmt = 0;
                if (discount.type === 'FIXED') discountAmt = discount.val;
                if (discount.type === 'PERCENT') discountAmt = (roomTotal * discount.val) / 100;
                if (discountAmt > roomTotal) discountAmt = roomTotal; 

                const totalBefore = roomTotal + z8Total + foodTotal;
                const netTotal = totalBefore - discountAmt;

                let deposit = 0;
                const isHigh = checkDateOverlapHighSeason(dates.checkIn, dates.checkOut);
                
                if (isHigh) {
                    deposit = netTotal;
                } else {
                    const roomDeposit = (roomTotal - discountAmt) * 0.5;
                    deposit = roomDeposit + z8Total + foodTotal;
                }
                
                return {
                    total: totalBefore,
                    discount: discountAmt,
                    netTotal: netTotal,
                    deposit: Math.ceil(deposit)
                };
            };

            // Submit Booking
            const handleSubmit = () => {
                if (!customer.name || !customer.phone) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£');
                if (!agreed) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á');
                if (!slipImg) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');
                
                setLoading(true);
                const pricing = getPricing();
                
                const payload = {
                    customer,
                    checkIn: dates.checkIn,
                    checkOut: dates.checkOut,
                    totalGuests: cart.filter(c => c.type !== 'food').reduce((s, c) => s + c.guests, 0),
                    cart,
                    pricing,
                    discountCode: discount.code,
                    slipImage: slipImg
                };

                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                })
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success') {
                        setBookingResult(res.bookingId);
                        setStep(5);
                    } else {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + res.message);
                    }
                    setLoading(false);
                })
                .catch(e => {
                    alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e);
                    setLoading(false);
                });
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onloadend = () => {
                    setSlipImg(reader.result);
                };
                reader.readAsDataURL(file);
            };

            const handleDragEnd = (id, e) => {
                if(!devMode) return;
                const rect = e.target.parentElement.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                setPinPos({ ...pinPos, [id]: {x, y} });
            };

            // --- RENDER ---

            if (step === 1) return (
                <div className="max-w-md mx-auto p-6 bg-white shadow-xl rounded-xl mt-10">
                    <img src="https://drive.google.com/uc?export=view&id=1Iq6GU727vQsip6GuESYmSpaFUHV3uj-k" className="w-32 mx-auto mb-4"/>
                    <h1 className="text-2xl font-bold text-center mb-6 text-green-800">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á üèïÔ∏è</h1>
                    
                    {customer.name ? (
                        <div className="bg-green-100 p-2 rounded text-green-800 text-center mb-4 text-sm">
                            üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì {customer.name}
                        </div>
                    ) : (
                        !liffError && <div className="text-center text-sm text-gray-500 mb-4">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å</div>
                    )}

                    <div className="space-y-4">
                        <div>
                            <label className="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å (Check-in)</label>
                            <input type="date" min={getTommorow()} className="w-full border p-2 rounded"
                                onChange={e => setDates({...dates, checkIn: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å (Check-out)</label>
                            <input type="date" min={dates.checkIn || getTommorow()} className="w-full border p-2 rounded"
                                onChange={e => setDates({...dates, checkOut: e.target.value})} />
                        </div>
                        <button onClick={handleSearch} disabled={loading}
                            className="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition font-bold">
                            {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ß‡πà‡∏≤‡∏á'}
                        </button>
                    </div>
                </div>
            );

            if (step === 2) return (
                <div className="max-w-4xl mx-auto p-4">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (‡∏ß‡πà‡∏≤‡∏á)</h2>
                        <button onClick={() => setDevMode(!devMode)} className="text-xs text-gray-400">Dev Mode</button>
                    </div>
                    
                    <div className="map-container bg-blue-100 mb-6" style={{paddingBottom: '56.25%'}}>
                        <img src="https://drive.google.com/uc?export=view&id=1MtBiMvqO5BBPLlY2SFssaFXJsg8qt9TT" 
                             className="absolute top-0 left-0 w-full h-full object-cover" />
                        
                        {Object.keys(pinPos).map(key => {
                            const isBooked = availability.bookedRooms.includes(key);
                            const isZ8Full = key === 'Z8' && availability.zone8Available <= 0;
                            const disable = isBooked || isZ8Full;
                            const inCart = cart.find(c => c.id === key);

                            return (
                                <div key={key} 
                                    className={`map-pin flex flex-col items-center ${disable ? 'opacity-50 grayscale' : ''} ${inCart ? 'selected' : ''}`}
                                    style={{left: `${pinPos[key].x}%`, top: `${pinPos[key].y}%`}}
                                    draggable={devMode}
                                    onDragEnd={(e) => handleDragEnd(key, e)}
                                    onClick={() => {
                                        if(disable) return;
                                        const r = ROOM_DATA[key];
                                        const guests = prompt(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${r.name} (${key === 'Z8' ? '‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ' + availability.zone8Available : r.tiers.map(t=>t.max).join('/')})`);
                                        if (guests) addToCart(key, parseInt(guests));
                                    }}
                                >
                                    <div className={`p-1 px-2 rounded-lg text-xs font-bold shadow-md whitespace-nowrap ${disable ? 'bg-gray-400 text-white' : (inCart ? 'bg-yellow-400 text-black' : 'bg-white text-green-800')}`}>
                                        {ROOM_DATA[key].name} {key==='Z8' && `(${availability.zone8Available})`}
                                    </div>
                                    <div className="text-2xl">üìç</div>
                                </div>
                            )
                        })}
                    </div>

                    <div className="bg-white p-4 rounded-lg shadow mb-4">
                        <h3 className="font-bold text-lg mb-2">üçΩÔ∏è ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                            {FOOD_MENU.map(f => (
                                <div key={f.id} className="flex justify-between items-center border p-2 rounded">
                                    <span>{f.name} ({f.price}.-)</span>
                                    <button onClick={() => addFood(f)} className="bg-orange-500 text-white px-2 rounded">+</button>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="bg-gray-100 p-4 rounded-lg mb-4">
                        <h3 className="font-bold">üõí ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ({cart.length})</h3>
                        {cart.map((c, i) => (
                            <div key={i} className="flex justify-between text-sm mt-1">
                                <span>{c.name} {c.type === 'food' ? `x${c.qty}` : `(${c.guests} ‡∏Ñ‡∏ô)`}</span>
                                <button onClick={() => setCart(cart.filter((_, idx) => idx !== i))} className="text-red-500">‡∏•‡∏ö</button>
                            </div>
                        ))}
                    </div>

                    <button onClick={() => cart.length > 0 ? setStep(3) : alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£')} 
                        className="w-full bg-green-600 text-white p-3 rounded-lg font-bold">
                        ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
                    </button>
                </div>
            );

            if (step === 3) {
                const pricing = getPricing();
                return (
                    <div className="max-w-md mx-auto p-6 bg-white shadow-xl rounded-xl">
                        <h2 className="text-xl font-bold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
                        
                        <div className="space-y-2 mb-4 text-sm">
                            <p><strong>‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å:</strong> {dates.checkIn} (14:00) - {dates.checkOut} (12:00)</p>
                            <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∑‡∏ô:</strong> {calculateNights()} ‡∏Ñ‡∏∑‡∏ô</p>
                            <hr/>
                            {cart.map((c, i) => (
                                <div key={i} className="flex justify-between">
                                    <span>{c.name} {c.type==='food' && `x${c.qty}`}</span>
                                    <span>{c.type==='food' ? c.price*c.qty : c.pricePerNight*calculateNights()} ‡∏ö.</span>
                                </div>
                            ))}
                            <hr/>
                            <div className="flex justify-between">
                                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                                <span>{pricing.total} ‡∏ö.</span>
                            </div>
                            {pricing.discount > 0 && <div className="flex justify-between text-green-600"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span><span>-{pricing.discount} ‡∏ö.</span></div>}
                            <div className="flex justify-between font-bold text-lg">
                                <span>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                                <span>{pricing.netTotal} ‡∏ö.</span>
                            </div>
                            <div className="bg-yellow-100 p-2 rounded text-center border border-yellow-300 mt-2">
                                <span className="block text-sm text-yellow-800">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô</span>
                                <span className="text-2xl font-bold text-red-600">{pricing.deposit} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                        </div>

                        <div className="flex gap-2 mb-4">
                            <input placeholder="‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" className="border p-2 rounded flex-1" 
                                onChange={e => setDiscount({...discount, code: e.target.value})} />
                            <button className="bg-gray-800 text-white px-4 rounded" onClick={() => {
                                fetch(`${GOOGLE_SCRIPT_URL}?action=checkDiscount&code=${discount.code}`)
                                    .then(r=>r.json()).then(d => {
                                        if(d.status === 'success') {
                                            setDiscount({...discount, val: parseInt(d.value), type: d.type});
                                            alert('‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                                        } else alert('‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                                    })
                            }}>‡πÉ‡∏ä‡πâ</button>
                        </div>

                        <div className="space-y-3 mb-6">
                            <div>
                                <label className="text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (‡∏à‡∏≤‡∏Å LINE)</label>
                                <div className="flex gap-2">
                                    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" className="w-full border p-2 rounded bg-gray-50"
                                        value={customer.name}
                                        onChange={e => setCustomer({...customer, name: e.target.value})} />
                                    {!customer.userId && (
                                        <button onClick={loginLine} className="bg-[#00B900] text-white px-4 rounded text-xs whitespace-nowrap">
                                            LINE Login
                                        </button>
                                    )}
                                </div>
                            </div>
                            <input placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å)" className="w-full border p-2 rounded" type="tel"
                                value={customer.phone}
                                onChange={e => setCustomer({...customer, phone: e.target.value})} />
                        </div>

                        <div className="text-center mb-6">
                            <p className="mb-2 font-bold">‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå)</p>
                            <canvas id="qr-code" className="mx-auto border p-2 rounded"></canvas>
                            <p className="text-sm mt-1">‡∏≠‡∏•‡∏á‡∏Å‡∏ï ‡∏ó‡∏ß‡∏µ‡∏ú‡πà‡∏≠‡∏á (061-592-4262)</p>
                        </div>
                        {React.useEffect(() => {
                            if(document.getElementById('qr-code')) {
                                const payload = generatePromptPayPayload("0615924262", pricing.deposit);
                                new QRious({
                                    element: document.getElementById('qr-code'),
                                    value: payload,
                                    size: 200
                                });
                            }
                        }, [pricing.deposit])}

                        <div className="mb-4">
                            <label className="block mb-1 text-sm">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                            <input type="file" accept="image/*" onChange={handleFileChange} className="w-full text-sm" />
                        </div>

                        <div className="flex items-start gap-2 mb-4 text-xs text-gray-600">
                            <input type="checkbox" className="mt-1" checked={agreed} onChange={e => setAgreed(e.target.checked)} />
                            <p>‡∏â‡∏±‡∏ô‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 7 ‡∏ß‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥/‡πÇ‡∏£‡∏Ñ‡∏£‡∏∞‡∏ö‡∏≤‡∏î) ‡πÄ‡∏î‡πá‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 3 ‡∏Ç‡∏ß‡∏ö‡∏û‡∏±‡∏Å‡∏ü‡∏£‡∏µ</p>
                        </div>

                        <button onClick={handleSubmit} disabled={loading}
                            className={`w-full p-3 rounded-lg font-bold text-white ${loading ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700'}`}>
                            {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á'}
                        </button>
                    </div>
                );
            }

            if (step === 5) return (
                <div className="max-w-md mx-auto p-10 text-center bg-white shadow-xl rounded-xl mt-10">
                    <div className="text-6xl mb-4">üéâ</div>
                    <h2 className="text-2xl font-bold text-green-700 mb-2">‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                    <p className="text-gray-600 mb-4">‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: <strong>{bookingResult}</strong></p>
                    <p className="text-sm text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏à‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á LINE ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡∏ö</p>
                    
                    {/* ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF */}
                    <button onClick={() => liff.closeWindow()} className="mt-8 bg-gray-800 text-white px-6 py-2 rounded-full">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
