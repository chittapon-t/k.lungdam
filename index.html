<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ขนำลุงดำ - จองที่พัก</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f1ea; color: #2c3e2d; }
        .bg-kanam { background-color: #2c3e2d; }
        .text-kanam { color: #2c3e2d; }
        
        #layout-container {
            position: relative; width: 100%; max-width: 600px; margin: 0 auto;
            border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .hotspot {
            position: absolute; width: 45px; height: 45px; border-radius: 50%;
            border: 2px solid white; cursor: pointer; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.3s; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .hotspot img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; opacity: 0.8; }
        .hotspot .room-label { position: relative; z-index: 10; font-size: 10px; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); background: rgba(0,0,0,0.3); width: 100%; text-align: center; }
        
        .status-available { border-color: #10b981; }
        .status-booked { border-color: #ef4444; cursor: not-allowed; grayscale: 100%; opacity: 0.6; }
        .status-booked::after { content: '✕'; position: absolute; z-index: 20; color: white; font-size: 20px; }
        .status-selected { border-color: #facc15; transform: scale(1.2); border-width: 3px; z-index: 50; }
        
        .step-content { display: none; }
        .step-content.active { display: block; }
        .food-card { transition: all 0.2s; border: 1px solid #e5e7eb; }
        .food-card.selected { border-color: #2c3e2d; background-color: #f0fdf4; }
    </style>
</head>
<body class="pb-10">
    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-lg">
        <div class="bg-kanam text-white p-6 text-center">
            <h1 class="text-2xl font-bold">ขนำลุงดำ</h1>
            <p class="text-sm opacity-80">โฮมสเตย์ & ลานกางเต็นท์</p>
        </div>

        <div class="p-4">
            <div class="flex justify-between mb-6 text-xs font-bold text-gray-400">
                <div id="p-1" class="text-kanam">1. เลือกวัน</div>
                <div id="p-2">2. เลือกห้อง & อาหาร</div>
                <div id="p-3">3. ข้อมูล & ชำระ</div>
            </div>

            <!-- Step 1 -->
            <div id="step-1" class="step-content active">
                <h2 class="text-lg font-bold mb-4">เลือกวันที่เข้าพัก</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm mb-1 text-gray-600">Check-in</label>
                        <input type="date" id="checkin" onchange="onCheckinChange()" class="w-full border p-2 rounded-lg outline-none">
                    </div>
                    <div>
                        <label class="block text-sm mb-1 text-gray-600">Check-out</label>
                        <input type="date" id="checkout" class="w-full border p-2 rounded-lg outline-none">
                    </div>
                </div>
                <button onclick="goToStep(2)" class="w-full bg-kanam text-white py-3 rounded-lg mt-6 font-bold shadow-lg">ถัดไป</button>
            </div>

            <!-- Step 2 -->
            <div id="step-2" class="step-content">
                <h2 class="text-lg font-bold mb-2 text-center text-kanam">เลือกบ้านพักของคุณ</h2>
                <div id="layout-container" class="mb-6">
                    <img src="https://lh3.googleusercontent.com/pw/AP1GczNzsJplv6jr4mDDSC8wsMLS6T8-qOXwcOW3nE2yXJ-z5WWRWw7Q2XssA87-tUh6NFuStIUbPxYcOzjup6jSEpgEG1rOs2vMQ0VZ3AcKP4-qisvj7gLWcZlP0p4YRJoWYBbLQpy7kcuuSoGHeP9c2Hmq=w913-h913-s-no-gm?authuser=0" class="w-full h-auto">
                </div>

                <div id="selected-rooms-list" class="space-y-3 mb-6"></div>

                <div class="mb-8 p-4 border rounded-lg bg-gray-50 border-kanam border-opacity-20">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-sm">ลานกางเต็นท์ (CAMP) ฿150/คน</span>
                        <div class="flex items-center gap-2">
                            <button onclick="updateCampPax(-1)" class="w-8 h-8 bg-white border rounded-full shadow">-</button>
                            <input type="number" id="camp-pax" value="0" readonly class="w-8 bg-transparent text-center font-bold">
                            <button onclick="updateCampPax(1)" class="w-8 h-8 bg-white border rounded-full shadow">+</button>
                        </div>
                    </div>
                </div>

                <h3 class="font-bold text-kanam mb-3">สั่งอาหารล่วงหน้า</h3>
                <div id="food-list" class="grid grid-cols-1 gap-3"></div>

                <div class="flex gap-2 mt-6">
                    <button onclick="goToStep(1)" class="w-1/3 border border-kanam text-kanam py-3 rounded-lg font-bold">ย้อนกลับ</button>
                    <button onclick="goToStep(3)" class="w-2/3 bg-kanam text-white py-3 rounded-lg font-bold shadow-lg">หน้าถัดไป</button>
                </div>
            </div>

            <!-- Step 3 -->
            <div id="step-3" class="step-content">
                <div id="booking-summary" class="bg-gray-50 p-4 rounded-lg mb-4 text-sm border-l-4 border-kanam shadow-inner"></div>

                <div class="mb-4 bg-white p-3 border rounded-lg shadow-sm">
                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">โค้ดส่วนลด</label>
                    <div class="flex gap-2">
                        <input type="text" id="promo-code" class="flex-1 border p-2 rounded-lg text-sm outline-none">
                        <button onclick="applyPromo()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-bold">ใช้โค้ด</button>
                    </div>
                    <p id="promo-msg" class="text-[10px] mt-1"></p>
                </div>

                <div class="space-y-3">
                    <input type="text" id="cust-name" oninput="validateForm()" placeholder="ชื่อ-นามสกุล ผู้จอง" class="w-full border p-3 rounded-lg outline-none">
                    <input type="tel" id="cust-phone" oninput="validateForm()" placeholder="เบอร์โทรศัพท์" class="w-full border p-3 rounded-lg outline-none">
                    <textarea id="cust-note" placeholder="หมายเหตุ" class="w-full border p-3 rounded-lg outline-none" rows="2"></textarea>
                </div>

                <div class="mt-6 border-t pt-4 text-center">
                    <h3 class="font-bold mb-2">ชำระเงินมัดจำ</h3>
                    <div class="bg-white border-2 border-dashed border-gray-200 p-4 rounded-xl shadow-sm">
                        <img id="qr-code" src="" class="mx-auto w-48 mb-2 rounded-lg">
                        <p class="text-2xl font-bold text-kanam">฿<span id="deposit-text">0</span></p>
                        <div class="text-xs text-gray-600 mt-2 font-bold">
                            <p>พร้อมเพย์: 061-592-4262</p>
                            <p>ชื่อบัญชี: อลงกต ทวีผ่อง</p>
                        </div>
                    </div>
                    
                    <label class="block mt-4 text-sm font-bold text-kanam text-left">แนบสลิปการโอน</label>
                    <input type="file" id="slip-file" onchange="validateForm()" accept="image/*" class="w-full mt-1 text-sm">
                </div>

                <div class="mt-6 flex items-start bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <input type="checkbox" id="terms" onchange="validateForm()" class="mt-1 mr-2 scale-125 accent-kanam">
                    <label for="terms" class="text-[11px] text-gray-600">
                        ยอมรับเงื่อนไข: ไม่มีการคืนเงินมัดจำทุกกรณี
                    </label>
                </div>

                <button id="btn-submit" disabled onclick="submitBooking()" class="w-full bg-gray-300 text-white py-4 rounded-xl mt-6 font-bold shadow-xl">ยืนยันการจอง</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwQjaz5oaVekrtSlw_kGqt9gLOg0uQeXphG4H2Q5cqrv4ZSEiJnzO63lctvaaYTRr9HNQ/exec"; 
        const LIFF_ID = "2008803474-hRJaVbm7";
        
        let masterData = { rooms: [], foods: [], promotions: [] };
        let selectedRooms = []; 
        let selectedFoods = [];
        let userProfile = {};
        let appliedPromo = null;
        let finalCalculation = { total: 0, deposit: 0, discount: 0 };

        async function init() {
            setInitialDates();
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) userProfile = await liff.getProfile();
                else liff.login();
                
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getInitialData' }) });
                masterData = await res.json();
                renderHotspots();
                renderFoodList();
            } catch (err) { console.error(err); }
        }

        function setInitialDates() {
            const today = new Date();
            const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
            document.getElementById('checkin').value = tomorrow.toISOString().split('T')[0];
            onCheckinChange();
        }

        function onCheckinChange() {
            const cin = document.getElementById('checkin').value;
            const next = new Date(cin); next.setDate(next.getDate() + 1);
            document.getElementById('checkout').value = next.toISOString().split('T')[0];
        }

        function renderHotspots() {
            const container = document.getElementById('layout-container');
            masterData.rooms.forEach(room => {
                if (room.id === 'CAMP') return;
                const div = document.createElement('div');
                div.className = `hotspot status-available shadow-md`;
                div.style.left = room.coords.x + '%'; div.style.top = room.coords.y + '%';
                div.innerHTML = `<img src="${room.imageUrl}"><span class="room-label">${room.id}</span>`;
                div.id = `room-${room.id}`;
                div.onclick = () => toggleRoom(room.id);
                container.appendChild(div);
            });
        }

        function toggleRoom(id) {
            const idx = selectedRooms.findIndex(r => r.id === id);
            const el = document.getElementById(`room-${id}`);
            if (idx > -1) {
                selectedRooms.splice(idx, 1);
                el.classList.replace('status-selected', 'status-available');
            } else {
                selectedRooms.push({ id: id, pax: id === 'NP' ? 4 : 1 });
                el.classList.replace('status-available', 'status-selected');
            }
            renderSelectedRoomsList();
        }

        function renderSelectedRoomsList() {
            const list = document.getElementById('selected-rooms-list');
            list.innerHTML = selectedRooms.map(item => `
                <div class="p-2 border rounded-lg bg-white flex justify-between items-center shadow-sm">
                    <span class="font-bold text-sm">${item.id}</span>
                    <div class="flex items-center gap-3">
                        <button onclick="updateRoomPax('${item.id}', -1)" class="w-7 h-7 bg-gray-100 rounded-full">-</button>
                        <span class="w-4 text-center font-bold text-sm">${item.pax}</span>
                        <button onclick="updateRoomPax('${item.id}', 1)" class="w-7 h-7 bg-gray-100 rounded-full">+</button>
                    </div>
                </div>
            `).join('') || '<div class="text-center py-4 text-gray-400 text-sm italic border-2 border-dashed rounded-lg">ยังไม่ได้เลือกห้องพัก</div>';
        }

        function updateRoomPax(id, val) {
            const item = selectedRooms.find(r => r.id === id);
            const room = masterData.rooms.find(r => r.id === id);
            let next = item.pax + val;
            if (next >= (id === 'NP' ? 4 : 1) && next <= room.maxPax) { item.pax = next; renderSelectedRoomsList(); }
        }

        function updateCampPax(val) {
            const input = document.getElementById('camp-pax');
            let next = parseInt(input.value) + val;
            if (next >= 0 && next <= 20) input.value = next;
        }

        function renderFoodList() {
            const container = document.getElementById('food-list');
            container.innerHTML = masterData.foods.map(food => `
                <div class="food-card p-3 rounded-lg flex justify-between items-center bg-white shadow-sm" id="food-card-${food.id}">
                    <span class="font-bold text-sm">${food.name} (฿${food.price})</span>
                    <div class="flex items-center gap-2">
                        <button onclick="updateFoodQty('${food.id}', -1)" class="w-7 h-7 bg-gray-100 rounded-full">-</button>
                        <span id="food-qty-${food.id}" class="w-5 text-center font-bold text-sm">0</span>
                        <button onclick="updateFoodQty('${food.id}', 1)" class="w-7 h-7 bg-gray-100 rounded-full">+</button>
                    </div>
                </div>
            `).join('');
        }

        function updateFoodQty(id, val) {
            let item = selectedFoods.find(f => f.foodID === id);
            if (!item) { item = { foodID: id, qty: 0 }; selectedFoods.push(item); }
            item.qty = Math.max(0, item.qty + val);
            document.getElementById(`food-qty-${id}`).innerText = item.qty;
            document.getElementById(`food-card-${id}`).classList.toggle('selected', item.qty > 0);
            if (item.qty === 0) selectedFoods = selectedFoods.filter(f => f.foodID !== id);
        }

        function goToStep(n) {
            if (n === 3) calculatePricing();
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${n}`).classList.add('active');
            window.scrollTo(0,0);
        }

        function calculatePricing() {
            let roomTotal = 0, foodTotal = 0;
            const cin = document.getElementById('checkin').value, cout = document.getElementById('checkout').value;
            let summaryHtml = `<div class="text-center border-b pb-2 mb-3"><p class="font-bold text-lg">ใบสรุปการจอง</p><p class="text-[10px] text-gray-500">${cin} ถึง ${cout}</p></div>`;
            
            selectedRooms.forEach(item => {
                let p = calculateSingleRoomPrice(item.id, item.pax);
                roomTotal += p; summaryHtml += `<div class="flex justify-between mb-1"><span>${item.id} (${item.pax} ท่าน)</span><span>฿${p.toLocaleString()}</span></div>`;
            });
            const cp = parseInt(document.getElementById('camp-pax').value);
            if (cp > 0) { roomTotal += (cp * 150); summaryHtml += `<div class="flex justify-between mb-1"><span>CAMP (${cp} ท่าน)</span><span>฿${(cp*150).toLocaleString()}</span></div>`; }

            let discount = appliedPromo ? (appliedPromo.type === 'percent' ? roomTotal * (appliedPromo.value/100) : appliedPromo.value) : 0;
            if (discount > 0) summaryHtml += `<div class="flex justify-between text-green-600 italic"><span>ส่วนลด (${appliedPromo.code})</span><span>-฿${discount.toLocaleString()}</span></div>`;

            summaryHtml += `<div class="border-t border-dashed my-2"></div>`;
            selectedFoods.forEach(item => {
                const f = masterData.foods.find(mf => mf.id === item.foodID);
                foodTotal += (f.price * item.qty);
                summaryHtml += `<div class="flex justify-between mb-1 text-gray-500"><span>+ ${f.name} x${item.qty}</span><span>฿${(f.price*item.qty).toLocaleString()}</span></div>`;
            });

            let total = (roomTotal - discount) + foodTotal;
            let deposit = ((roomTotal - discount) * 0.5) + foodTotal;
            finalCalculation = { total, deposit };

            summaryHtml += `<div class="mt-4 pt-2 border-t-2 border-kanam"><div class="flex justify-between text-sm"><span>ยอดรวม</span><span>฿${total.toLocaleString()}</span></div><div class="flex justify-between text-lg font-bold text-red-600"><span>ยอดมัดจำ</span><span>฿${deposit.toLocaleString()}</span></div></div>`;
            document.getElementById('booking-summary').innerHTML = summaryHtml;
            document.getElementById('deposit-text').innerText = deposit.toLocaleString();
            document.getElementById('qr-code').src = `https://promptpay.io/0615924262/${deposit}`;
        }

        function calculateSingleRoomPrice(id, pax) {
            if (id === 'NP') return pax >= 6 ? 2200 : 1600;
            if (id.startsWith('RN')) return pax === 3 ? 1750 : 1400;
            if (id.startsWith('G')) return pax >= 3 ? 1550 : 1200;
            return 0;
        }

        function validateForm() {
            const name = document.getElementById('cust-name').value.trim();
            const phone = document.getElementById('cust-phone').value.trim();
            const slip = document.getElementById('slip-file').files.length > 0;
            const terms = document.getElementById('terms').checked;
            document.getElementById('btn-submit').disabled = !(name && phone && slip && terms);
            document.getElementById('btn-submit').classList.toggle('bg-kanam', (name && phone && slip && terms));
        }

        async function submitBooking() {
            const file = document.getElementById('slip-file').files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const payload = {
                    action: 'createBooking',
                    checkIn: document.getElementById('checkin').value,
                    checkOut: document.getElementById('checkout').value,
                    customer: { name: document.getElementById('cust-name').value, phone: document.getElementById('cust-phone').value, lineID: userProfile.userId || 'Guest' },
                    rooms: [ ...selectedRooms.map(r => ({ roomID: r.id, pax: r.pax, price: calculateSingleRoomPrice(r.id, r.pax) })), ...(parseInt(document.getElementById('camp-pax').value) > 0 ? [{ roomID: 'CAMP', pax: document.getElementById('camp-pax').value, price: 150 }] : []) ],
                    foods: selectedFoods.map(f => ({ foodID: f.foodID, qty: f.qty, price: masterData.foods.find(mf => mf.id === f.foodID).price })),
                    promoCode: appliedPromo?.code || "",
                    totalPrice: finalCalculation.total, deposit: finalCalculation.deposit,
                    slipBase64: reader.result
                };
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.status === 'success') { alert("จองสำเร็จ!"); liff.closeWindow(); }
                else alert(result.message);
            };
        }
        init();
    </script>
</body>
</html>
