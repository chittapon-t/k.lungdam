<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ** ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Apps Script ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ index.html **
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQjaz5oaVekrtSlw_kGqt9gLOg0uQeXphG4H2Q5cqrv4ZSEiJnzO63lctvaaYTRr9HNQ/exec"; 

        const AdminApp = () => {
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [bookings, setBookings] = React.useState([]);
            const [viewSlip, setViewSlip] = React.useState(null); 
            const [filter, setFilter] = React.useState('all'); 

            // Helper: ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢
            const formatThaiDate = (dateStr) => {
                if(!dateStr || dateStr === '-') return "-";
                const date = new Date(dateStr);
                const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
                return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
            };

            const handleLogin = (e) => {
                e.preventDefault();
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'adminLogin', password: password })
                })
                .then(r => r.json())
                .then(res => {
                    setLoading(false);
                    if (res.status === 'success') {
                        setIsLoggedIn(true);
                        fetchData();
                    } else {
                        alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    }
                })
                .catch(err => {
                    setLoading(false);
                    alert('Error: ' + err);
                });
            };

            const fetchData = () => {
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getAdminData', password: password })
                })
                .then(r => r.json())
                .then(res => {
                    setLoading(false);
                    if (res.status === 'success') {
                        setBookings(res.data);
                    }
                });
            };

            const updateStatus = (id, newStatus) => {
                if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${newStatus}"?`)) return;
                
                // Optimistic Update
                setBookings(prev => prev.map(b => b.id === id ? {...b, status: newStatus} : b));

                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updateStatus', bookingId: id, newStatus: newStatus, password: password })
                })
                .then(r => r.json())
                .then(res => {
                    if (res.status !== 'success') {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                        fetchData(); 
                    }
                });
            };

            const getStatusColor = (status) => {
                if (status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                if (status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô') return 'bg-green-100 text-green-800 border-green-200';
                if (status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' || status === 'Cancelled') return 'bg-red-100 text-red-800 border-red-200';
                return 'bg-gray-100 text-gray-800';
            };

            const filteredBookings = bookings.filter(b => {
                if (filter === 'all') return true;
                if (filter === 'pending') return b.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                if (filter === 'confirmed') return b.status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                return true;
            });

            // --- LOGIN SCREEN ---
            if (!isLoggedIn) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 px-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
                        <div className="text-center mb-6">
                            <h1 className="text-3xl font-bold text-green-800">Admin Panel</h1>
                            <p className="text-gray-500">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input 
                                type="password" 
                                placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin (999)" 
                                className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                value={password}
                                onChange={e => setPassword(e.target.value)}
                            />
                            <button disabled={loading} className="w-full bg-gray-800 text-white p-3 rounded-lg hover:bg-gray-700 transition font-bold shadow-lg">
                                {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}
                            </button>
                        </form>
                    </div>
                </div>
            );

            // --- DASHBOARD SCREEN ---
            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <nav className="bg-white shadow p-4 sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="font-bold text-xl text-green-800 flex items-center gap-2">
                                <span>üèïÔ∏è</span> <span className="hidden md:inline">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={fetchData} className="p-2 px-4 bg-gray-100 rounded-full text-gray-600 hover:text-green-600 hover:bg-green-50 transition">
                                    <i className="fas fa-sync mr-1"></i> ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î
                                </button>
                                <button onClick={() => window.location.reload()} className="p-2 px-4 bg-red-50 rounded-full text-red-500 hover:bg-red-100 transition">
                                    ‡∏≠‡∏≠‡∏Å
                                </button>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-7xl mx-auto p-4 mt-6">
                        {/* Stats Cards */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-white p-4 rounded-xl shadow border-l-4 border-yellow-400">
                                <h3 className="text-gray-500 text-xs uppercase">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
                                <p className="text-2xl font-bold text-yellow-600">{bookings.filter(b => b.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö').length}</p>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow border-l-4 border-green-400">
                                <h3 className="text-gray-500 text-xs uppercase">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h3>
                                <p className="text-2xl font-bold text-green-600">{bookings.filter(b => b.status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô').length}</p>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow border-l-4 border-blue-400 col-span-2 md:col-span-2">
                                <h3 className="text-gray-500 text-xs uppercase">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏£‡∏ß‡∏° (‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß)</h3>
                                <p className="text-2xl font-bold text-blue-600">
                                    {bookings.filter(b => b.status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô').reduce((sum, b) => sum + parseInt(b.deposit || 0), 0).toLocaleString()} ‡∏ø
                                </p>
                            </div>
                        </div>

                        {/* Filters */}
                        <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                            {['all', 'pending', 'confirmed'].map(f => (
                                <button key={f} 
                                    onClick={() => setFilter(f)}
                                    className={`px-5 py-2 rounded-full text-sm font-bold transition whitespace-nowrap ${filter === f ? 'bg-gray-800 text-white shadow-lg' : 'bg-white text-gray-600 shadow hover:bg-gray-50'}`}>
                                    {f === 'all' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : (f === 'pending' ? '‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ' : '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß')}
                                </button>
                            ))}
                        </div>

                        {/* Table */}
                        <div className="bg-white rounded-xl shadow overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-gray-500">
                                    <thead className="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                        <tr>
                                            <th className="px-6 py-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                            <th className="px-6 py-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</th>
                                            <th className="px-6 py-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                            <th className="px-6 py-4 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                            <th className="px-6 py-4 text-center">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
                                            <th className="px-6 py-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {filteredBookings.map((b) => (
                                            <tr key={b.id} className="hover:bg-gray-50 transition">
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <span className={`px-2.5 py-1 rounded-full text-xs font-bold border ${getStatusColor(b.status)}`}>
                                                        {b.status}
                                                    </span>
                                                    <div className="text-xs text-gray-400 mt-2 font-mono">{b.timestamp.split(' ')[0]}</div>
                                                    <div className="text-xs text-gray-300 font-mono">{b.id}</div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded font-bold">IN</span>
                                                        <span>{formatThaiDate(b.checkIn)}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded font-bold">OUT</span>
                                                        <span>{formatThaiDate(b.checkOut)}</span>
                                                    </div>
                                                    {b.food !== '-' && (
                                                        <div className="text-xs bg-orange-50 text-orange-800 p-2 rounded border border-orange-100">
                                                            üçΩÔ∏è {b.food}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div className="font-bold text-gray-900 text-base">{b.name}</div>
                                                    <div className="text-sm text-gray-600 mb-1">üìû <a href={`tel:${b.phone}`} className="hover:text-blue-600">{b.phone.replace(/'/,'')}</a></div>
                                                    {b.lineProfile !== '-' && (
                                                        <div className="text-xs text-green-600 flex items-center gap-1">
                                                            <i className="fab fa-line"></i> {b.lineProfile}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 text-right">
                                                    <div className="text-gray-500 text-xs">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div>
                                                    <div className="font-bold">{parseInt(b.price).toLocaleString()}</div>
                                                    <div className="text-red-500 text-xs mt-1">‡∏°‡∏±‡∏î‡∏à‡∏≥</div>
                                                    <div className="font-bold text-red-600 text-lg">{parseInt(b.deposit).toLocaleString()}</div>
                                                </td>
                                                <td className="px-6 py-4 text-center">
                                                    {b.slip.includes('http') ? (
                                                        <button onClick={() => setViewSlip(b.slip)} className="group relative inline-block">
                                                            <img src={b.slip} className="w-12 h-12 rounded object-cover border-2 border-gray-200 group-hover:border-blue-500 transition" />
                                                            <span className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs text-blue-600 opacity-0 group-hover:opacity-100 transition whitespace-nowrap">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π</span>
                                                        </button>
                                                    ) : <span className="text-gray-300 text-xs">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ -</span>}
                                                </td>
                                                <td className="px-6 py-4 text-center">
                                                    {b.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' && (
                                                        <div className="flex flex-col gap-2">
                                                            <button onClick={() => updateStatus(b.id, '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô')} className="bg-green-500 text-white px-4 py-1.5 rounded-lg hover:bg-green-600 text-xs font-bold shadow-sm transition">
                                                                ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                                            </button>
                                                            <button onClick={() => updateStatus(b.id, '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')} className="bg-white border border-red-200 text-red-500 px-4 py-1.5 rounded-lg hover:bg-red-50 text-xs transition">
                                                                ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                                                            </button>
                                                        </div>
                                                    )}
                                                    {b.status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' && (
                                                        <button onClick={() => updateStatus(b.id, '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')} className="text-gray-400 hover:text-red-500 text-xs underline">
                                                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
                                                        </button>
                                                    )}
                                                    {b.status.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') && (
                                                        <span className="text-gray-300 text-xs">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                        {filteredBookings.length === 0 && (
                                            <tr>
                                                <td colSpan="6" className="text-center py-12">
                                                    <div className="text-gray-300 text-4xl mb-2">üì≠</div>
                                                    <div className="text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* Modal ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ */}
                    {viewSlip && (
                        <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4" onClick={() => setViewSlip(null)}>
                            <div className="relative max-w-2xl w-full max-h-screen flex flex-col items-center">
                                <button className="absolute -top-10 right-0 text-white text-xl hover:text-gray-300" onClick={() => setViewSlip(null)}>
                                    <i className="fas fa-times"></i> ‡∏õ‡∏¥‡∏î
                                </button>
                                <img src={viewSlip} className="max-w-full max-h-[85vh] rounded-lg shadow-2xl" />
                                <a href={viewSlip} target="_blank" className="mt-4 text-white underline text-sm bg-gray-800 px-4 py-2 rounded-full">
                                    <i className="fas fa-external-link-alt mr-2"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
                                </a>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>
