<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบหลังบ้าน - ขนำลุงดำ แคมป์ปิ้ง</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
        .calendar-day { min-height: 80px; }
        @media(max-width: 640px){ .calendar-day { min-height: 50px; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQjaz5oaVekrtSlw_kGqt9gLOg0uQeXphG4H2Q5cqrv4ZSEiJnzO63lctvaaYTRr9HNQ/exec"; 

        const compressImage = async (file) => {
            return new Promise((resolve, reject) => {
                const maxWidth = 800;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        const AdminApp = () => {
            const [token, setToken] = React.useState(localStorage.getItem('adminToken'));
            const [password, setPassword] = React.useState('');
            const [activeTab, setActiveTab] = React.useState('dashboard');
            const [bookings, setBookings] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const [viewBooking, setViewBooking] = React.useState(null);
            const [rescheduleData, setRescheduleData] = React.useState(null);
            
            // Settings State
            const [settings, setSettings] = React.useState(null);
            const [savingSettings, setSavingSettings] = React.useState(false);

            const login = () => {
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'adminLogin', password })
                }).then(r => r.json()).then(res => {
                    setLoading(false);
                    if (res.status === 'success') {
                        localStorage.setItem('adminToken', 'logged_in');
                        localStorage.setItem('adminPass', password);
                        setToken('logged_in');
                    } else {
                        alert('รหัสผ่านไม่ถูกต้อง');
                    }
                });
            };

            const logout = () => {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminPass');
                setToken(null);
            };

            const fetchData = () => {
                const pass = localStorage.getItem('adminPass');
                if(!pass) return;
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getAdminData', password: pass })
                }).then(r => r.json()).then(res => {
                    setLoading(false);
                    if (res.status === 'success') setBookings(res.data);
                });
            };

            const fetchSettings = () => {
                const pass = localStorage.getItem('adminPass');
                if(!pass) return;
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getSiteSettings', password: pass })
                }).then(r => r.json()).then(res => {
                    setLoading(false);
                    if (res.status === 'success') {
                        setSettings(res.data);
                    }
                });
            };

            React.useEffect(() => {
                if (token) {
                    if (activeTab === 'dashboard' || activeTab === 'calendar') fetchData();
                    if (activeTab === 'settings') fetchSettings();
                }
            }, [token, activeTab]);

            const updateStatus = (id, newStatus) => {
                if(!confirm(`ยืนยันเปลี่ยนสถานะเป็น ${newStatus}?`)) return;
                const pass = localStorage.getItem('adminPass');
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updateStatus', password: pass, bookingId: id, newStatus })
                }).then(r => r.json()).then(res => {
                    if(res.status === 'success') fetchData();
                });
            };

            const handleReschedule = () => {
                if(!rescheduleData.checkIn || !rescheduleData.checkOut) return alert('ระบุวันที่ให้ครบ');
                const pass = localStorage.getItem('adminPass');
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'rescheduleBooking', password: pass, bookingId: viewBooking.id, newCheckIn: rescheduleData.checkIn, newCheckOut: rescheduleData.checkOut })
                }).then(r => r.json()).then(res => {
                    setLoading(false);
                    if(res.status === 'success') { alert('เลื่อนวันสำเร็จ'); setRescheduleData(null); setViewBooking(null); fetchData(); }
                    else alert('Error: ' + res.message);
                });
            };

            const handleSaveSettings = () => {
                if(!confirm('ยืนยันบันทึกการตั้งค่า?')) return;
                const pass = localStorage.getItem('adminPass');
                setSavingSettings(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'saveSiteSettings', password: pass, settings: settings })
                }).then(r => r.json()).then(res => {
                    setSavingSettings(false);
                    if(res.status === 'success') {
                         alert('บันทึกเรียบร้อย');
                         fetchSettings(); // Refresh to see updated URLs
                    } else {
                        alert('บันทึกไม่สำเร็จ');
                    }
                });
            };

            const handleImageUpload = async (file, callback) => {
                if(file) {
                    try {
                        const base64 = await compressImage(file);
                        callback(base64);
                    } catch(e) { alert('Upload Failed'); }
                }
            };

            if (!token) return (
                <div className="flex items-center justify-center min-h-screen">
                    <div className="bg-white p-8 rounded shadow-md w-80">
                        <h2 className="text-xl font-bold mb-4 text-center">Admin Login</h2>
                        <input type="password" placeholder="Password" className="w-full border p-2 rounded mb-4" value={password} onChange={e => setPassword(e.target.value)} />
                        <button onClick={login} disabled={loading} className="w-full bg-blue-600 text-white p-2 rounded">{loading ? 'Checking...' : 'Login'}</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-10">
                    <nav className="bg-white shadow p-4 mb-6 sticky top-0 z-50">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <h1 className="font-bold text-gray-800">ขนำลุงดำ Manager</h1>
                            <div className="flex gap-2 text-sm">
                                <button onClick={()=>setActiveTab('dashboard')} className={`px-3 py-1 rounded ${activeTab==='dashboard'?'bg-blue-100 text-blue-600':'text-gray-500'}`}>รายการจอง</button>
                                <button onClick={()=>setActiveTab('calendar')} className={`px-3 py-1 rounded ${activeTab==='calendar'?'bg-blue-100 text-blue-600':'text-gray-500'}`}>ปฏิทิน</button>
                                <button onClick={()=>setActiveTab('settings')} className={`px-3 py-1 rounded ${activeTab==='settings'?'bg-blue-100 text-blue-600':'text-gray-500'}`}>ตั้งค่าร้านค้า</button>
                                <button onClick={logout} className="text-red-500 ml-2">Logout</button>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-6xl mx-auto px-4">
                        {/* --- DASHBOARD TAB --- */}
                        {activeTab === 'dashboard' && (
                            <div className="bg-white rounded-lg shadow overflow-hidden">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50 border-b">
                                        <tr>
                                            <th className="p-3 text-left">ID</th>
                                            <th className="p-3 text-left">ลูกค้า</th>
                                            <th className="p-3 text-left">เข้าพัก</th>
                                            <th className="p-3 text-left">สถานะ</th>
                                            <th className="p-3 text-left">จัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {bookings.map(b => (
                                            <tr key={b.id} className="border-b hover:bg-gray-50">
                                                <td className="p-3">{b.id}</td>
                                                <td className="p-3">
                                                    <div className="font-bold">{b.name}</div>
                                                    <div className="text-xs text-gray-500">{b.phone}</div>
                                                </td>
                                                <td className="p-3">
                                                    <div>{b.checkIn}</div>
                                                    <div className="text-xs text-gray-400">ถึง {b.checkOut}</div>
                                                </td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 rounded text-xs ${b.status==='ยืนยัน'?'bg-green-100 text-green-700': b.status==='ยกเลิก'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}`}>{b.status}</span>
                                                </td>
                                                <td className="p-3">
                                                    <button onClick={()=>setViewBooking(b)} className="text-blue-600 hover:underline">ดูข้อมูล</button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {/* --- CALENDAR TAB --- */}
                        {activeTab === 'calendar' && (
                            <div className="bg-white rounded-lg shadow p-4">
                                <h2 className="font-bold mb-4">ปฏิทินการจอง</h2>
                                <iframe src="https://calendar.google.com/calendar/embed?src=c_c920556778ec795c345b583f7a18f8e70a4a83968d26859e9a48972d733190be%40group.calendar.google.com&ctz=Asia%2FBangkok" style={{border:0}} width="100%" height="600" frameBorder="0" scrolling="no"></iframe>
                            </div>
                        )}

                        {/* --- SETTINGS TAB (NEW) --- */}
                        {activeTab === 'settings' && settings && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-gray-800"><i className="fas fa-store mr-2"></i>ตั้งค่าร้านค้า</h2>
                                    <button onClick={handleSaveSettings} disabled={savingSettings} className="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 disabled:bg-gray-400">
                                        {savingSettings ? 'กำลังบันทึก...' : 'บันทึกการเปลี่ยนแปลง'}
                                    </button>
                                </div>

                                {/* 1. General Info */}
                                <div className="mb-8 border-b pb-6">
                                    <h3 className="font-bold text-lg mb-4 text-blue-600">ข้อมูลทั่วไป</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-1">ชื่อร้าน (Title)</label>
                                            <input className="w-full border p-2 rounded" value={settings.headerTitle} onChange={e => setSettings({...settings, headerTitle: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-1">คำอธิบายร้าน (Description)</label>
                                            <textarea className="w-full border p-2 rounded" rows="3" value={settings.headerDesc} onChange={e => setSettings({...settings, headerDesc: e.target.value})}></textarea>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-1">รูปโลโก้ (Logo)</label>
                                            <div className="flex items-center gap-4">
                                                <img src={settings.logoUrl} className="w-16 h-16 rounded-full border object-cover" />
                                                <input type="file" onChange={e => handleImageUpload(e.target.files[0], base64 => setSettings({...settings, logoUrl: base64}))} className="text-sm" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-1">รูปแบนเนอร์ (Banner)</label>
                                            <div className="flex items-center gap-4">
                                                <img src={settings.bannerUrl} className="w-32 h-16 rounded border object-cover" />
                                                <input type="file" onChange={e => handleImageUpload(e.target.files[0], base64 => setSettings({...settings, bannerUrl: base64}))} className="text-sm" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 2. Room Images */}
                                <div className="mb-8 border-b pb-6">
                                    <h3 className="font-bold text-lg mb-4 text-blue-600">รูปภาพห้องพัก</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {['R1','R2','R3','T1','T2','K1','K2','Z8'].map(roomId => (
                                            <div key={roomId} className="border p-3 rounded bg-gray-50">
                                                <h4 className="font-bold mb-2">{roomId}</h4>
                                                <div className="flex flex-wrap gap-2 mb-2">
                                                    {(settings.roomImages[roomId] || []).map((img, idx) => (
                                                        <div key={idx} className="relative w-16 h-16">
                                                            <img src={img} className="w-full h-full object-cover rounded" />
                                                            <button onClick={() => {
                                                                const newImgs = settings.roomImages[roomId].filter((_, i) => i !== idx);
                                                                setSettings({...settings, roomImages: {...settings.roomImages, [roomId]: newImgs}});
                                                            }} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-xs flex items-center justify-center">×</button>
                                                        </div>
                                                    ))}
                                                </div>
                                                <input type="file" className="text-xs w-full" onChange={e => handleImageUpload(e.target.files[0], base64 => {
                                                    const current = settings.roomImages[roomId] || [];
                                                    setSettings({...settings, roomImages: {...settings.roomImages, [roomId]: [...current, base64]}});
                                                })} />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* 3. Food Menu */}
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg text-blue-600">เมนูอาหาร</h3>
                                        <button onClick={() => {
                                            const newFood = { id: 'F'+(settings.foodMenu.length+1), name: 'เมนูใหม่', price: 0, img: '' };
                                            setSettings({...settings, foodMenu: [...settings.foodMenu, newFood]});
                                        }} className="bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-200">+ เพิ่มเมนู</button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {settings.foodMenu.map((food, idx) => (
                                            <div key={idx} className="border p-3 rounded flex gap-3 bg-white items-start">
                                                <div className="w-20 h-20 bg-gray-200 rounded flex-shrink-0 relative overflow-hidden">
                                                    {food.img ? <img src={food.img} className="w-full h-full object-cover" /> : <div className="flex items-center justify-center h-full text-gray-400 text-xs">No Img</div>}
                                                    <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => handleImageUpload(e.target.files[0], base64 => {
                                                        const newFoods = [...settings.foodMenu];
                                                        newFoods[idx].img = base64;
                                                        setSettings({...settings, foodMenu: newFoods});
                                                    })} />
                                                </div>
                                                <div className="flex-1 space-y-2">
                                                    <input className="w-full border p-1 rounded text-sm" placeholder="ชื่อเมนู" value={food.name} onChange={e => {
                                                        const newFoods = [...settings.foodMenu];
                                                        newFoods[idx].name = e.target.value;
                                                        setSettings({...settings, foodMenu: newFoods});
                                                    }} />
                                                    <div className="flex items-center gap-2">
                                                        <input type="number" className="w-20 border p-1 rounded text-sm" placeholder="ราคา" value={food.price} onChange={e => {
                                                            const newFoods = [...settings.foodMenu];
                                                            newFoods[idx].price = parseInt(e.target.value) || 0;
                                                            setSettings({...settings, foodMenu: newFoods});
                                                        }} />
                                                        <span className="text-sm text-gray-500">บาท</span>
                                                    </div>
                                                </div>
                                                <button onClick={() => {
                                                    const newFoods = settings.foodMenu.filter((_, i) => i !== idx);
                                                    setSettings({...settings, foodMenu: newFoods});
                                                }} className="text-red-500 hover:text-red-700"><i className="fas fa-trash"></i></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'settings' && !settings && loading && <div className="text-center py-10">กำลังโหลดการตั้งค่า...</div>}
                    </div>

                    {/* Modal Booking Detail */}
                    {viewBooking && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
                                <h2 className="text-xl font-bold mb-4">รายละเอียดการจอง</h2>
                                <div className="space-y-2 text-sm">
                                    <p><strong>ID:</strong> {viewBooking.id}</p>
                                    <p><strong>ลูกค้า:</strong> {viewBooking.name} ({viewBooking.phone})</p>
                                    <p><strong>วันเข้าพัก:</strong> {viewBooking.checkIn} - {viewBooking.checkOut}</p>
                                    <p><strong>ห้องพัก:</strong> {viewBooking.rooms}</p>
                                    <p><strong>อาหาร:</strong> {viewBooking.food}</p>
                                    <p><strong>ยอดรวม:</strong> {viewBooking.price} บ. (มัดจำ {viewBooking.deposit} บ.)</p>
                                    
                                    <div className="my-4 border-t pt-4">
                                        <p className="mb-2 font-bold">จัดการสถานะ:</p>
                                        <div className="flex gap-2">
                                            <button onClick={()=>updateStatus(viewBooking.id, 'ยืนยัน')} className="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">ยืนยัน</button>
                                            <button onClick={()=>updateStatus(viewBooking.id, 'ยกเลิก')} className="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">ยกเลิก</button>
                                            <button onClick={()=>updateStatus(viewBooking.id, 'รอตรวจสอบ')} className="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">รอตรวจสอบ</button>
                                        </div>
                                    </div>

                                    <div className="border-t pt-4 space-y-2">
                                        {!rescheduleData ? (
                                            <button onClick={() => setRescheduleData({checkIn: viewBooking.checkIn, checkOut: viewBooking.checkOut})} className="w-full py-2 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">ขอเลื่อนวันเข้าพัก</button>
                                        ) : (
                                            <div className="bg-orange-50 p-3 rounded border border-orange-200">
                                                <label className="block text-xs font-bold mb-1">วันเข้าพักใหม่</label>
                                                <input type="date" className="w-full border p-1 rounded text-sm mb-2" value={rescheduleData.checkIn} onChange={e => setRescheduleData({...rescheduleData, checkIn: e.target.value})} />
                                                <label className="block text-xs font-bold mb-1">วันออกใหม่</label>
                                                <input type="date" className="w-full border p-1 rounded text-sm" value={rescheduleData.checkOut} onChange={e => setRescheduleData({...rescheduleData, checkOut: e.target.value})} />
                                                <div className="flex gap-2 mt-2">
                                                    <button onClick={() => setRescheduleData(null)} className="flex-1 py-1 bg-gray-200 text-gray-600 rounded text-xs">ยกเลิก</button>
                                                    <button onClick={handleReschedule} className="flex-1 py-1 bg-orange-600 text-white rounded text-xs">บันทึก</button>
                                                </div>
                                            </div>
                                        )}
                                        {viewBooking.slip.includes('http') ? 
                                            <a href={viewBooking.slip} target="_blank" className="block w-full text-center py-2 border border-blue-500 text-blue-500 rounded hover:bg-blue-50">ดูสลิปโอนเงิน</a> :
                                            <div className="text-red-500 text-center text-xs">ไม่พบสลิป (Error/No Slip)</div>
                                        }
                                        <button onClick={() => { setViewBooking(null); setRescheduleData(null); }} className="w-full py-2 bg-gray-200 rounded hover:bg-gray-300">ปิดหน้าต่าง</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>
