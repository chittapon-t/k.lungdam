<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ** ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Apps Script ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà **
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQjaz5oaVekrtSlw_kGqt9gLOg0uQeXphG4H2Q5cqrv4ZSEiJnzO63lctvaaYTRr9HNQ/exec"; 

        const AdminApp = () => {
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [bookings, setBookings] = React.useState([]);
            const [viewSlip, setViewSlip] = React.useState(null); // URL slip to show in modal
            const [filter, setFilter] = React.useState('all'); // all, pending, confirmed

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Login
            const handleLogin = (e) => {
                e.preventDefault();
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'adminLogin', password: password })
                })
                .then(r => r.json())
                .then(res => {
                    setLoading(false);
                    if (res.status === 'success') {
                        setIsLoggedIn(true);
                        fetchData();
                    } else {
                        alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    }
                })
                .catch(err => {
                    setLoading(false);
                    alert('Error: ' + err);
                });
            };

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
            const fetchData = () => {
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getAdminData', password: password })
                })
                .then(r => r.json())
                .then(res => {
                    setLoading(false);
                    if (res.status === 'success') {
                        setBookings(res.data);
                    }
                });
            };

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            const updateStatus = (id, newStatus) => {
                if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${newStatus}"?`)) return;
                
                // Optimistic Update (‡πÅ‡∏Å‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ã‡∏ü‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏•‡∏∑‡πà‡∏ô)
                setBookings(prev => prev.map(b => b.id === id ? {...b, status: newStatus} : b));

                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updateStatus', bookingId: id, newStatus: newStatus, password: password })
                })
                .then(r => r.json())
                .then(res => {
                    if (res.status !== 'success') {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                        fetchData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏û‡∏•‡∏≤‡∏î
                    }
                });
            };

            const getStatusColor = (status) => {
                if (status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') return 'bg-yellow-100 text-yellow-800';
                if (status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô') return 'bg-green-100 text-green-800';
                if (status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' || status === 'Cancelled') return 'bg-red-100 text-red-800';
                return 'bg-gray-100 text-gray-800';
            };

            const filteredBookings = bookings.filter(b => {
                if (filter === 'all') return true;
                if (filter === 'pending') return b.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                if (filter === 'confirmed') return b.status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                return true;
            });

            // --- LOGIN SCREEN ---
            if (!isLoggedIn) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900">
                    <div className="bg-white p-8 rounded-lg shadow-2xl w-96">
                        <h2 className="text-2xl font-bold text-center mb-6 text-gray-800">Admin Login</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input 
                                type="password" 
                                placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin" 
                                className="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-green-500"
                                value={password}
                                onChange={e => setPassword(e.target.value)}
                            />
                            <button disabled={loading} className="w-full bg-gray-800 text-white p-3 rounded hover:bg-gray-700 transition">
                                {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}
                            </button>
                        </form>
                    </div>
                </div>
            );

            // --- DASHBOARD SCREEN ---
            return (
                <div className="min-h-screen pb-10">
                    {/* Header */}
                    <nav className="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-10">
                        <div className="font-bold text-xl text-green-800">üèïÔ∏è ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ Manager</div>
                        <div className="flex gap-2">
                            <button onClick={fetchData} className="p-2 text-gray-600 hover:text-green-600"><i className="fas fa-sync"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                            <button onClick={() => window.location.reload()} className="p-2 text-red-500 hover:text-red-700">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                        </div>
                    </nav>

                    <div className="max-w-7xl mx-auto p-4 mt-6">
                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className="bg-white p-4 rounded shadow border-l-4 border-yellow-400">
                                <h3 className="text-gray-500 text-sm">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
                                <p className="text-3xl font-bold text-yellow-600">{bookings.filter(b => b.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö').length}</p>
                            </div>
                            <div className="bg-white p-4 rounded shadow border-l-4 border-green-400">
                                <h3 className="text-gray-500 text-sm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                                <p className="text-3xl font-bold text-green-600">{bookings.filter(b => b.status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô').length}</p>
                            </div>
                            <div className="bg-white p-4 rounded shadow border-l-4 border-blue-400">
                                <h3 className="text-gray-500 text-sm">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (‡∏°‡∏±‡∏î‡∏à‡∏≥)</h3>
                                <p className="text-3xl font-bold text-blue-600">
                                    {bookings.filter(b => b.status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô').reduce((sum, b) => sum + parseInt(b.deposit), 0).toLocaleString()} ‡∏ö.
                                </p>
                            </div>
                        </div>

                        {/* Filters */}
                        <div className="flex gap-2 mb-4 overflow-x-auto">
                            {['all', 'pending', 'confirmed'].map(f => (
                                <button key={f} 
                                    onClick={() => setFilter(f)}
                                    className={`px-4 py-2 rounded-full text-sm font-bold ${filter === f ? 'bg-gray-800 text-white' : 'bg-white text-gray-600 shadow'}`}>
                                    {f === 'all' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : (f === 'pending' ? '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß')}
                                </button>
                            ))}
                        </div>

                        {/* Table */}
                        <div className="bg-white rounded shadow overflow-x-auto">
                            <table className="w-full text-sm text-left text-gray-500">
                                <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th className="px-6 py-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                        <th className="px-6 py-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                        <th className="px-6 py-3">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                        <th className="px-6 py-3">‡∏™‡∏•‡∏¥‡∏õ</th>
                                        <th className="px-6 py-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredBookings.map((b) => (
                                        <tr key={b.id} className="bg-white border-b hover:bg-gray-50">
                                            <td className="px-6 py-4">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${getStatusColor(b.status)}`}>
                                                    {b.status}
                                                </span>
                                                <div className="text-xs text-gray-400 mt-1">{b.timestamp.split(' ')[0]}</div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="font-bold text-gray-900">{b.id}</div>
                                                <div>{b.checkIn} ‚ûù {b.checkOut}</div>
                                                <div className="text-xs text-blue-600">{b.food !== '-' ? `‡∏≠‡∏≤‡∏´‡∏≤‡∏£: ${b.food}` : ''}</div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="text-gray-900 font-bold">{b.name}</div>
                                                <div className="text-xs">üìû {b.phone.replace(/'/,'')}</div>
                                                {b.lineProfile !== '-' && <div className="text-xs text-green-600">LINE: {b.lineProfile}</div>}
                                            </td>
                                            <td className="px-6 py-4">
                                                <div>‡∏£‡∏ß‡∏°: {parseInt(b.price).toLocaleString()}</div>
                                                <div className="text-red-600 font-bold">‡∏°‡∏±‡∏î‡∏à‡∏≥: {parseInt(b.deposit).toLocaleString()}</div>
                                            </td>
                                            <td className="px-6 py-4">
                                                {b.slip.includes('http') ? (
                                                    <button onClick={() => setViewSlip(b.slip)} className="text-blue-600 hover:underline">
                                                        <i className="fas fa-image"></i> ‡∏î‡∏π‡∏£‡∏π‡∏õ
                                                    </button>
                                                ) : <span className="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>}
                                            </td>
                                            <td className="px-6 py-4">
                                                {b.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' && (
                                                    <div className="flex gap-2">
                                                        <button onClick={() => updateStatus(b.id, '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô')} className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-xs">
                                                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                                                        </button>
                                                        <button onClick={() => updateStatus(b.id, '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-xs">
                                                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                                        </button>
                                                    </div>
                                                )}
                                                {b.status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' && (
                                                    <button onClick={() => updateStatus(b.id, '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')} className="text-red-500 hover:text-red-700 text-xs border border-red-200 px-2 py-1 rounded">
                                                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                                    </button>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                    {filteredBookings.length === 0 && (
                                        <tr>
                                            <td colSpan="6" className="text-center py-8 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Modal ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ */}
                    {viewSlip && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={() => setViewSlip(null)}>
                            <div className="bg-white rounded-lg p-2 max-w-lg w-full relative">
                                <button className="absolute top-2 right-2 bg-gray-200 rounded-full w-8 h-8 font-bold" onClick={() => setViewSlip(null)}>X</button>
                                <img src={viewSlip} className="w-full h-auto rounded" />
                                <div className="text-center mt-2">
                                    <a href={viewSlip} target="_blank" className="text-blue-600 text-sm underline">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°</a>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>
