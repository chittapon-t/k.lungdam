<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <style>
    body { font-family: 'Kanit', sans-serif; background: #f8fafc; }
    .st-Pending { background: #fef3c7; color: #b45309; }
    .st-Confirmed { background: #dcfce7; color: #15803d; }
    .st-Cancelled { background: #fee2e2; color: #b91c1c; }
    .tab-active { border-bottom: 2px solid #2c3e2d; color: #2c3e2d; font-weight: bold; }
  </style>
</head>
<body class="min-h-screen">
  
  <div id="login-guard" class="fixed inset-0 bg-slate-800 z-50 flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl w-full max-w-sm text-center shadow-2xl">
      <h2 class="text-2xl font-bold mb-4">üîê Admin Access</h2>
      <input type="password" id="admin-pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 border rounded-xl mb-4 text-center">
      <button onclick="checkAuth()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>

  <div id="main-app" class="max-w-7xl mx-auto px-4 py-6 hidden">
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-2xl font-bold text-slate-700">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ Management</h1>
        <div class="flex gap-2">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="px-4 py-2 tab-active transition">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="px-4 py-2 text-slate-400 hover:text-slate-700 transition">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button onclick="loadData()" class="bg-white px-4 py-2 rounded-lg shadow-sm border hover:bg-slate-50 ml-4">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
    </header>

    <!-- Tab 1: Dashboard -->
    <div id="content-dashboard" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border">
            <div id="calendar"></div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border h-[600px] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <div id="booking-list" class="space-y-3">Loading...</div>
        </div>
    </div>

    <!-- Tab 2: Settings (Master Data) -->
    <div id="content-settings" class="hidden space-y-8">
        <!-- 1. Promotions -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">üéüÔ∏è ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
                <button onclick="openAddModal('promotion')" class="bg-green-600 text-white px-3 py-1 rounded text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            <table class="w-full text-sm text-left">
                <thead class="bg-slate-100 text-slate-500"><tr><th class="p-3">Code</th><th class="p-3">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th><th class="p-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="p-3">‡∏•‡∏ö</th></tr></thead>
                <tbody id="list-promo"></tbody>
            </table>
        </div>

        <!-- 2. Special Dates -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">‚ú® ‡∏ß‡∏±‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥)</h3>
                <button onclick="openAddModal('special')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            <table class="w-full text-sm text-left">
                <thead class="bg-slate-100 text-slate-500"><tr><th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3">‡∏°‡∏±‡∏î‡∏à‡∏≥ %</th><th class="p-3">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th class="p-3">‡∏•‡∏ö</th></tr></thead>
                <tbody id="list-special"></tbody>
            </table>
        </div>

        <!-- 3. Closed Dates -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">üö´ ‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
                <button onclick="openAddModal('closed')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            <table class="w-full text-sm text-left">
                <thead class="bg-slate-100 text-slate-500"><tr><th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î</th><th class="p-3">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th><th class="p-3">‡∏•‡∏ö</th></tr></thead>
                <tbody id="list-closed"></tbody>
            </table>
        </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-40 p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-2xl">&times;</button>
        <div id="modal-content"></div>
    </div>
  </div>

  <!-- Add Data Modal -->
  <div id="add-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
        <h3 id="add-title" class="font-bold text-lg mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <div id="add-form-content" class="space-y-3"></div>
        <div class="flex gap-2 mt-6">
            <button onclick="submitAdd()" class="flex-1 bg-slate-800 text-white py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="document.getElementById('add-modal').classList.add('hidden')" class="flex-1 bg-gray-200 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQjaz5oaVekrtSlw_kGqt9gLOg0uQeXphG4H2Q5cqrv4ZSEiJnzO63lctvaaYTRr9HNQ/exec';
    let bookings = [], masterData = {};
    let currentAddType = '';

    function checkAuth() {
        if(document.getElementById('admin-pass').value === '1234') {
            document.getElementById('login-guard').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            loadData();
        } else alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î');
    }

    function switchTab(tab) {
        document.getElementById('content-dashboard').classList.add('hidden');
        document.getElementById('content-settings').classList.add('hidden');
        document.getElementById('tab-dashboard').classList.remove('tab-active', 'text-slate-400');
        document.getElementById('tab-settings').classList.remove('tab-active', 'text-slate-400');
        
        document.getElementById(`content-${tab}`).classList.remove('hidden');
        document.getElementById(`tab-${tab}`).classList.add('tab-active');
        
        // Reset inactive styles
        if(tab==='dashboard') document.getElementById('tab-settings').classList.add('text-slate-400');
        else document.getElementById('tab-dashboard').classList.add('text-slate-400');
    }

    async function loadData() {
        try {
            const [bRes, mRes] = await Promise.all([
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllBookings' }) }),
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getInitialData' }) })
            ]);
            bookings = await bRes.json();
            masterData = await mRes.json();
            
            renderCalendar();
            renderList();
            renderSettings();
        } catch(e) { alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
    }

    // --- Dashboard Logic ---
    function renderList() {
        document.getElementById('booking-list').innerHTML = bookings.map(b => `
            <div onclick="openModal('${b.bookingID}')" class="p-4 border rounded-xl hover:bg-slate-50 cursor-pointer relative group">
                <div class="absolute left-0 top-0 bottom-0 w-1 ${b.status==='Confirmed'?'bg-green-500':b.status==='Pending'?'bg-yellow-400':'bg-red-500'} rounded-l-xl"></div>
                <div class="flex justify-between items-start">
                    <span class="font-bold">${b.name}</span>
                    <span class="text-xs px-2 py-0.5 rounded st-${b.status}">${b.status}</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">üìÖ ${b.checkIn} - ${b.checkOut}</div>
            </div>
        `).join('');
    }

    function renderCalendar() {
        const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth', locale: 'th', height: 500,
            events: bookings.filter(b => b.status !== 'Cancelled').map(b => ({
                title: b.name, start: b.checkIn, end: b.checkOut,
                color: b.status === 'Confirmed' ? '#166534' : '#EAB308',
                id: b.bookingID
            })),
            eventClick: (info) => openModal(info.event.id)
        });
        calendar.render();
    }

    function openModal(id) {
        const b = bookings.find(x => x.bookingID === id);
        const slip = b.slipUrl && b.slipUrl.includes('drive') ? b.slipUrl.replace('/file/d/', '/uc?id=').replace('/view?usp=sharing','') : b.slipUrl;
        
        document.getElementById('modal-content').innerHTML = `
            <h2 class="font-bold text-xl mb-4">${b.name}</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${b.status}</p>
                    <p class="text-sm">‡πÇ‡∏ó‡∏£: ${b.phone}</p>
                    <div class="my-4 border-t pt-2">
                        <p class="font-bold">‡∏¢‡∏≠‡∏î: ${b.totalPrice}</p>
                        <p class="text-green-600">‡∏°‡∏±‡∏î‡∏à‡∏≥: ${b.deposit}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateStatus('${b.bookingID}', 'Confirmed')" class="bg-green-600 text-white px-4 py-2 rounded text-sm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button onclick="updateStatus('${b.bookingID}', 'Cancelled')" class="bg-red-100 text-red-600 px-4 py-2 rounded text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
                <div><a href="${b.slipUrl}" target="_blank"><img src="${slip}" class="w-full rounded border"></a></div>
            </div>
        `;
        document.getElementById('modal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('modal').classList.add('hidden'); }

    async function updateStatus(id, st) {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?')) return;
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateBookingStatus', bookingID: id, status: st }) });
        closeModal(); loadData();
    }

    // --- Settings Logic ---
    function renderSettings() {
        // Promos
        document.getElementById('list-promo').innerHTML = masterData.promotions.map(p => `
            <tr class="border-b hover:bg-slate-50">
                <td class="p-3 font-bold">${p.code}</td>
                <td class="p-3">${p.value}</td>
                <td class="p-3">${p.type === 'percent' ? '%' : '‡∏ö‡∏≤‡∏ó'}</td>
                <td class="p-3"><button onclick="deleteData('promotion', '${p.code}')" class="text-red-500">‡∏•‡∏ö</button></td>
            </tr>
        `).join('');

        // Special
        document.getElementById('list-special').innerHTML = masterData.specialDates.map(s => `
            <tr class="border-b hover:bg-slate-50">
                <td class="p-3">${s.start} - ${s.end}</td>
                <td class="p-3 font-bold text-blue-600">${s.depositRate}%</td>
                <td class="p-3 text-xs text-gray-500">${s.note}</td>
                <td class="p-3"><button onclick="deleteData('special', '${s.start}')" class="text-red-500">‡∏•‡∏ö</button></td>
            </tr>
        `).join('');

        // Closed
        document.getElementById('list-closed').innerHTML = masterData.closedDates.map(c => `
            <tr class="border-b hover:bg-slate-50">
                <td class="p-3">${c.start} - ${c.end}</td>
                <td class="p-3 font-bold text-red-600">${c.roomID}</td>
                <td class="p-3 text-xs text-gray-500">${c.reason}</td>
                <td class="p-3"><button onclick="deleteData('closed', '${c.start}')" class="text-red-500">‡∏•‡∏ö</button></td>
            </tr>
        `).join('');
    }

    function openAddModal(type) {
        currentAddType = type;
        const form = document.getElementById('add-form-content');
        document.getElementById('add-modal').classList.remove('hidden');
        
        if (type === 'promotion') {
            document.getElementById('add-title').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î';
            form.innerHTML = `
                <input id="inp-1" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡πâ‡∏î (‡πÄ‡∏ä‡πà‡∏ô SAVE10)" class="w-full border p-2 rounded uppercase">
                <input id="inp-2" type="number" placeholder="‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" class="w-full border p-2 rounded">
                <select id="inp-3" class="w-full border p-2 rounded"><option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)</option><option value="baht">‡∏ö‡∏≤‡∏ó (THB)</option></select>
                <input id="inp-4" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" class="w-full border p-2 rounded">
            `;
        } else if (type === 'special') {
            document.getElementById('add-title').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©';
            form.innerHTML = `
                <div class="flex gap-2"><input type="date" id="inp-1" class="w-full border p-2 rounded"><input type="date" id="inp-2" class="w-full border p-2 rounded"></div>
                <input id="inp-3" type="number" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥ (0-100)" class="w-full border p-2 rounded">
                <input id="inp-4" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•/‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•" class="w-full border p-2 rounded">
            `;
        } else if (type === 'closed') {
            document.getElementById('add-title').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£';
            form.innerHTML = `
                <div class="flex gap-2"><input type="date" id="inp-1" class="w-full border p-2 rounded"><input type="date" id="inp-2" class="w-full border p-2 rounded"></div>
                <select id="inp-3" class="w-full border p-2 rounded">
                    <option value="ALL">‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á)</option>
                    ${masterData.rooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                </select>
                <input id="inp-4" placeholder="‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏" class="w-full border p-2 rounded">
            `;
        }
    }

    async function submitAdd() {
        const v1 = document.getElementById('inp-1').value;
        const v2 = document.getElementById('inp-2').value;
        const v3 = document.getElementById('inp-3').value;
        const v4 = document.getElementById('inp-4').value;
        
        if(!v1 || !v2) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

        const payload = [v1, v2, v3, v4];
        
        // Button Loading State
        const btn = event.target; btn.innerText = 'Saving...'; btn.disabled = true;

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'manageMasterData', operation: 'add', type: currentAddType, payload: payload })
            });
            document.getElementById('add-modal').classList.add('hidden');
            loadData();
        } catch(e) { alert('Error'); }
        finally { btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; btn.disabled = false; }
    }

    async function deleteData(type, key) {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?')) return;
        await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'manageMasterData', operation: 'delete', type: type, payload: [key] })
        });
        loadData();
    }
  </script>
</body>
</html>
