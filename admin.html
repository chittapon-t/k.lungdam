<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบหลังบ้าน - ขนำลุงดำ แคมป์ปิ้ง</title>
    
    <!-- React & Libs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
        .calendar-day { min-height: 80px; }
        @media(max-width: 640px){ .calendar-day { min-height: 50px; } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .animate-modal { animation: popIn 0.2s ease-out forwards; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Map Pin */
        .map-pin {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: grab;
            transition: transform 0.1s;
        }
        .map-pin:active { cursor: grabbing; transform: translate(-50%, -50%) scale(1.1); }
        .map-pin.active { background-color: #22c55e; z-index: 10; transform: translate(-50%, -50%) scale(1.2); }

        /* ซ่อนส่วนพิมพ์ในหน้าจอปกติ */
        #print-container {
            display: none;
        }

        /* --- PRINT STYLES --- */
        @media print {
            .no-print, .no-print * {
                display: none !important;
            }

            body, html {
                margin: 0;
                padding: 0;
                background: white;
                height: 100%;
                overflow: visible !important;
            }

            #print-container {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                display: block !important;
                background: white;
                z-index: 9999;
                visibility: visible !important;
            }
            
            /* ซ่อนทุกอย่างใน Print Container ก่อน แล้วค่อยเปิดด้วย JS */
            #print-container > div {
                display: none;
            }

            /* สไตล์สำหรับใบเสร็จ */
            #receipt-print-area {
                width: 210mm; /* A4 Portrait */
                min-height: 297mm;
                padding: 15mm;
                background-color: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* สไตล์สำหรับรายงาน */
            #report-print-area {
                width: 297mm; /* A4 Landscape */
                min-height: 210mm;
                padding: 15mm;
                background-color: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBfnBBAzldCRb5iH7RCRi7gE0RL4ClsEa7R-p84j3s6S_OpLwhzsE4g9pUC2T8AVNG/exec"; 
        const SHOP_PHONE = "061-592-4262"; // เบอร์พร้อมเพย์
        
        let ROOM_IDS = ['R1','R2','R3','T1','T2','K1','K2','Z8'];
        let ROOM_NAMES = {
            'R1': 'โฮมสเตย์หนำโป', 'R2': 'บ้านพักริมน้ำ 1', 'R3': 'บ้านพักริมน้ำ 2',
            'T1': 'เต็นท์กระโจม 1', 'T2': 'เต็นท์กระโจม 2', 'K1': 'เช่าเต็นท์สนาม K1',
            'K2': 'เช่าเต็นท์สนาม K2', 'Z8': 'ลานกางเต็นท์'
        };

        const compressImage = async (file) => {
            return new Promise((resolve, reject) => {
                const maxWidth = 800;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        const StatusBadge = ({ status }) => {
            let color = 'bg-gray-100 text-gray-800';
            const safeStatus = String(status || '');
            if (safeStatus === 'รอตรวจสอบ') color = 'bg-yellow-100 text-yellow-800';
            if (safeStatus === 'ยืนยัน') color = 'bg-green-100 text-green-800';
            if (safeStatus.includes('ยกเลิก')) color = 'bg-red-100 text-red-800';
            return <span className={`px-2 py-1 rounded text-xs font-bold border ${color}`}>{safeStatus}</span>;
        };

        const AdminApp = () => {
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [activeTab, setActiveTab] = React.useState('dashboard');
            
            const [bookings, setBookings] = React.useState([]);
            const [settings, setSettings] = React.useState({ discounts: [], closed: [], special: [], roomClosures: [] });
            const [siteSettings, setSiteSettings] = React.useState(null);
            const [savingSiteSettings, setSavingSiteSettings] = React.useState(false);
            const [roomConfig, setRoomConfig] = React.useState({});
            const [mapConfig, setMapConfig] = React.useState({});

            const [viewSlip, setViewSlip] = React.useState(null); 
            const [viewBooking, setViewBooking] = React.useState(null); 
            const [filter, setFilter] = React.useState('all'); 
            const [searchTerm, setSearchTerm] = React.useState(''); 

            const [rescheduleData, setRescheduleData] = React.useState(null);
            const [selectedAddFood, setSelectedAddFood] = React.useState('');
            const [addFoodQty, setAddFoodQty] = React.useState(1);

            const [editMode, setEditMode] = React.useState(null); 
            const [formDiscount, setFormDiscount] = React.useState({ code: '', type: 'FIXED', value: '' });
            const [formClosed, setFormClosed] = React.useState({ startDate: '', endDate: '', reason: '' });
            const [formSpecial, setFormSpecial] = React.useState({ startDate: '', endDate: '', desc: '' });
            const [formRoomClosure, setFormRoomClosure] = React.useState({ startDate: '', endDate: '', roomId: 'R1', reason: '' });

            const [showAdminBooking, setShowAdminBooking] = React.useState(false);
            const [adminBookingForm, setAdminBookingForm] = React.useState({ name: '', phone: '', checkIn: '', checkOut: '', rooms: [], price: '', deposit: '' });
            const [adminAvailability, setAdminAvailability] = React.useState(null); 
            const [loadingAvailability, setLoadingAvailability] = React.useState(false);

            // --- Room Manager State ---
            const [editingRoom, setEditingRoom] = React.useState(null); 
            const [roomsMapData, setRoomsMapData] = React.useState([]); // combined data for convenience

            const [calendarDate, setCalendarDate] = React.useState(new Date());

            const [modal, setModal] = React.useState({ isOpen: false, type: 'alert', title: '', message: '', onConfirm: null });

            const showModal = (title, message, type = 'alert', onConfirm = null) => { setModal({ isOpen: true, title, message, type, onConfirm }); };
            const closeModal = () => setModal(prev => ({ ...prev, isOpen: false }));
            const alertMsg = (message, title = 'แจ้งเตือน', type = 'warning') => showModal(title, message, type, closeModal);
            const successMsg = (message) => alertMsg(message, 'สำเร็จ', 'success');
            const errorMsg = (message) => alertMsg(message, 'เกิดข้อผิดพลาด', 'error');
            const confirmMsg = (message, onConfirm) => showModal('ยืนยันการทำรายการ', message, 'confirm', () => { closeModal(); onConfirm(); });

            const formatThaiDate = (dateStr) => {
                if(!dateStr || dateStr === '-') return "-";
                const date = new Date(dateStr);
                const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
                return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
            };

            React.useEffect(() => {
                if (showAdminBooking && adminBookingForm.checkIn && adminBookingForm.checkOut) {
                    if (adminBookingForm.checkIn < adminBookingForm.checkOut) {
                        setLoadingAvailability(true);
                        setAdminBookingForm(prev => ({...prev, rooms: []})); 
                        fetch(`${GOOGLE_SCRIPT_URL}?action=getAvailability&checkIn=${adminBookingForm.checkIn}&checkOut=${adminBookingForm.checkOut}&_t=${Date.now()}`)
                            .then(r => r.json())
                            .then(res => { setLoadingAvailability(false); if (res.status === 'success') setAdminAvailability(res); })
                            .catch(e => setLoadingAvailability(false));
                    }
                } else { setAdminAvailability(null); }
            }, [showAdminBooking, adminBookingForm.checkIn, adminBookingForm.checkOut]);

            const stats = React.useMemo(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const totalRevenue = bookings.filter(b => b.status === 'ยืนยัน').reduce((sum, b) => sum + parseInt(b.deposit || 0), 0);
                const monthlyRevenue = bookings.filter(b => { const d = new Date(b.checkIn); return b.status === 'ยืนยัน' && d.getMonth() === currentMonth && d.getFullYear() === currentYear; }).reduce((sum, b) => sum + parseInt(b.deposit || 0), 0);
                const pendingCount = bookings.filter(b => b.status === 'รอตรวจสอบ').length;
                const monthlyCounts = Array(12).fill(0);
                bookings.forEach(b => { if (b.status !== 'ยกเลิก' && b.status !== 'Cancelled') { const d = new Date(b.checkIn); if (d.getFullYear() === currentYear) { monthlyCounts[d.getMonth()]++; } } });
                const upcoming = bookings.filter(b => { const checkIn = new Date(b.checkIn); const diffTime = checkIn - now; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); return b.status === 'ยืนยัน' && diffDays >= 0 && diffDays <= 3; }).sort((a,b) => new Date(a.checkIn) - new Date(b.checkIn));
                return { totalRevenue, monthlyRevenue, pendingCount, monthlyCounts, upcoming };
            }, [bookings]);

            const filteredBookings = React.useMemo(() => {
                const today = new Date();
                today.setHours(0,0,0,0);
                let result = bookings.filter(b => {
                    const bCheckIn = new Date(b.checkIn);
                    bCheckIn.setHours(0,0,0,0);
                    let statusMatch = false;
                    
                    if (filter === 'all') statusMatch = true;
                    else if (filter === 'pending') statusMatch = b.status === 'รอตรวจสอบ';
                    else if (filter === 'confirmed') statusMatch = b.status === 'ยืนยัน'; 
                    else if (filter === 'upcoming') statusMatch = b.status === 'ยืนยัน' && bCheckIn >= today;
                    else if (filter === 'history') statusMatch = b.status === 'ยืนยัน' && bCheckIn < today;

                    if (!statusMatch) return false;
                    
                    const term = searchTerm.toLowerCase();
                    const bId = String(b.id || '').toLowerCase();
                    const bName = String(b.name || '').toLowerCase();
                    const bPhone = String(b.phone || '').toLowerCase();
                    const bLine = String(b.lineProfile || '').toLowerCase();
                    return bId.includes(term) || bName.includes(term) || bPhone.includes(term) || bLine.includes(term);
                });
                
                if (filter === 'upcoming') {
                    result.sort((a, b) => new Date(a.checkIn) - new Date(b.checkIn));
                }
                return result;
            }, [bookings, filter, searchTerm]);

            // Combine roomConfig + mapConfig + siteSettings for Room Manager
            React.useEffect(() => {
                if (Object.keys(roomConfig).length > 0) {
                    const combined = Object.values(roomConfig).map(r => ({
                        ...r,
                        x: mapConfig[r.id]?.x || 50,
                        y: mapConfig[r.id]?.y || 50,
                        desc: siteSettings?.roomDescriptions?.[r.id] || '',
                        images: siteSettings?.roomImages?.[r.id] || []
                    }));
                    setRoomsMapData(combined);
                }
            }, [roomConfig, mapConfig, siteSettings]);

            const handleLogin = (e) => {
                e.preventDefault();
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'adminLogin', password: password }) })
                .then(r => r.json()).then(res => {
                    setLoading(false);
                    if (res.status === 'success') { 
                        setIsLoggedIn(true); 
                        fetchData(); 
                        fetchSettings(); 
                        fetchRoomConfig(); 
                        fetchMapConfig(); 
                    } else errorMsg('รหัสผ่านไม่ถูกต้อง');
                }).catch(err => { setLoading(false); errorMsg('Connection Error: ' + err); });
            };

            const fetchData = () => {
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAdminData', password: password }) })
                .then(r => r.json()).then(res => { setLoading(false); if (res.status === 'success') setBookings(res.data); });
            };

            const fetchSettings = () => {
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getSettings', password: password }) }).then(r => r.json()).then(res => { if (res.status === 'success') setSettings(res); });
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getSiteSettings', password: password }) }).then(r => r.json()).then(res => { if (res.status === 'success') setSiteSettings(res.data); });
            };

            const fetchRoomConfig = () => {
                fetch(`${GOOGLE_SCRIPT_URL}?action=getRoomConfig&_t=${Date.now()}`).then(r => r.json()).then(res => { if (res.status === 'success') { setRoomConfig(res.data); const loadedIds = Object.keys(res.data); if (loadedIds.length > 0) { ROOM_IDS = loadedIds; ROOM_NAMES = {}; loadedIds.forEach(id => ROOM_NAMES[id] = res.data[id].name); } } });
            };

            const fetchMapConfig = () => {
                fetch(`${GOOGLE_SCRIPT_URL}?action=getMapConfig&_t=${Date.now()}`).then(r => r.json()).then(res => { if (res.status === 'success') setMapConfig(res.data); });
            };

            const updateStatus = (id, newStatus) => {
                const actionText = newStatus === 'ยกเลิก' ? 'ยกเลิกรายการ' : `เปลี่ยนสถานะเป็น "${newStatus}"`;
                confirmMsg(`ยืนยันการ${actionText} ใช่หรือไม่?`, () => {
                    setBookings(prev => prev.map(b => b.id === id ? {...b, status: newStatus} : b));
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', bookingId: id, newStatus: newStatus, password: password }) });
                    if (newStatus === 'ยกเลิก' && viewBooking && viewBooking.id === id) setViewBooking({...viewBooking, status: 'ยกเลิก'});
                });
            };

            const handleCreateAdminBooking = () => {
                const { name, phone, checkIn, checkOut, rooms, price, deposit } = adminBookingForm;
                if(!name || !phone || !checkIn || !checkOut || rooms.length === 0 || !price) return alertMsg('กรุณากรอกข้อมูลให้ครบถ้วน');
                confirmMsg('ยืนยันสร้างรายการจอง?', () => {
                    setLoading(true);
                    const cart = rooms.map(rid => ({ id: rid, name: ROOM_NAMES[rid] || rid, type: (rid==='Z8'?'ground':(rid.startsWith('K')?'tent_rent':(rid.startsWith('T')?'tent':'room'))), guests: 2, qty: 1 }));
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'createAdminBooking', password: password, customer: { name, phone }, checkIn, checkOut, totalGuests: 2, cart: cart, price: parseFloat(price), deposit: parseFloat(deposit || price) })
                    }).then(r => r.json()).then(res => { setLoading(false); if(res.status === 'success') { successMsg('สร้างรายการจองสำเร็จ'); fetchData(); setShowAdminBooking(false); setAdminBookingForm({ name: '', phone: '', checkIn: '', checkOut: '', rooms: [], price: '', deposit: '' }); setAdminAvailability(null); } else errorMsg('ไม่สำเร็จ: ' + res.message); });
                });
            };

            const handleReschedule = () => {
                if(!rescheduleData.checkIn || !rescheduleData.checkOut) return alertMsg('กรุณาเลือกวันที่ให้ครบถ้วน');
                if(rescheduleData.checkIn >= rescheduleData.checkOut) return alertMsg('วันที่ออกต้องอยู่หลังวันที่เข้าพัก');
                confirmMsg('ยืนยันการเลื่อนวันเข้าพัก?', () => {
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'rescheduleBooking', bookingId: rescheduleData.id, newCheckIn: rescheduleData.checkIn, newCheckOut: rescheduleData.checkOut, password: password }) 
                    }).then(r => r.json()).then(res => { if (res.status === 'success') { successMsg('เลื่อนวันสำเร็จเรียบร้อย'); setRescheduleData(null); setViewBooking(null); fetchData(); } else errorMsg('ไม่สำเร็จ: ' + res.message); });
                });
            };

            const handleAddFood = () => {
                if(!selectedAddFood) return alertMsg('กรุณาเลือกเมนูอาหาร');
                const foodItem = siteSettings.foodMenu.find(f => f.id === selectedAddFood);
                if(!foodItem) return;
                confirmMsg(`ยืนยันเพิ่ม ${foodItem.name} จำนวน ${addFoodQty} ชุด?`, () => {
                    setLoading(true);
                    if(!foodItem.id || !foodItem.name) return errorMsg('ข้อมูลอาหารไม่ถูกต้อง');
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addFoodToBooking', bookingId: viewBooking.id, foodItem: { id: foodItem.id, name: foodItem.name, price: foodItem.price, qty: parseInt(addFoodQty) }, password: password })
                    }).then(r => r.json()).then(res => { setLoading(false); if(res.status === 'success') { successMsg('เพิ่มรายการอาหารเรียบร้อย'); fetchData(); setViewBooking(null); } else { errorMsg('Error: ' + res.message); } });
                });
            };

            const handleSaveSetting = (type, payload) => {
                const action = editMode ? 'editSetting' : 'addSetting'; const id = editMode ? editMode.id : null;
                if ((type !== 'discount') && (!payload.startDate || !payload.endDate)) return alertMsg('กรุณาระบุวันที่เริ่มต้นและสิ้นสุด');
                confirmMsg('ยืนยันการบันทึกข้อมูล?', () => {
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action, type, id, payload, password: password }) }).then(r => r.json()).then(res => { if (res.status === 'success') { successMsg('บันทึกสำเร็จ'); fetchSettings(); setEditMode(null); setFormDiscount({ code: '', type: 'FIXED', value: '' }); setFormClosed({ startDate: '', endDate: '', reason: '' }); setFormSpecial({ startDate: '', endDate: '', desc: '' }); setFormRoomClosure({ startDate: '', endDate: '', roomId: 'R1', reason: '' }); } else errorMsg('บันทึกไม่สำเร็จ'); });
                });
            };
            const startEdit = (type, item) => alertMsg('การแก้ไขช่วงวันที่ต้องลบแล้วเพิ่มใหม่ครับ');
            const handleDeleteSetting = (type, id) => confirmMsg('ยืนยันการลบรายการนี้?', () => { fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteSetting', type, id, password: password }) }).then(r => r.json()).then(res => { if (res.status === 'success') fetchSettings(); }); });
            const handleSaveSiteSettings = () => confirmMsg('ยืนยันบันทึกการตั้งค่าร้านค้า?', () => { setSavingSiteSettings(true); fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'saveSiteSettings', password: password, settings: siteSettings }) }).then(r => r.json()).then(res => { setSavingSiteSettings(false); if(res.status === 'success') { successMsg('บันทึกเรียบร้อย'); fetchSettings(); } else errorMsg('บันทึกไม่สำเร็จ'); }); });
            const handleImageUpload = async (file, callback) => { if(file) { try { const base64 = await compressImage(file); callback(base64); } catch(e) { errorMsg('Upload Failed'); } } };
            const handleMultipleImageUpload = async (files, callback) => { if (!files || files.length === 0) return; try { const promises = Array.from(files).map(file => compressImage(file)); const base64List = await Promise.all(promises); callback(base64List); } catch(e) { errorMsg('Upload Failed'); } };
            const handleExport = () => { const header = ["BookingID", "Date", "Customer", "Phone", "CheckIn", "CheckOut", "Rooms", "Total", "Deposit", "Status"]; const rows = bookings.map(b => [ b.id, b.timestamp, `"${b.name}"`, `'${b.phone}`, b.checkIn, b.checkOut, `"${b.rooms.replace(/"/g, '""')}"`, b.price, b.deposit, b.status ]); const csvContent = [header.join(","), ...rows.map(r => r.join(","))].join("\n"); const blob = new Blob(["\uFEFF"+csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", "bookings_lungdam.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            
            // --- PDF EXPORT (Report uses html2pdf) ---
            const handleExportPDF = () => {
                const element = document.getElementById('report-print-area');
                const opt = { 
                    margin: 0, 
                    filename: `Report_${new Date().toISOString().split('T')[0]}.pdf`, 
                    image: { type: 'jpeg', quality: 0.98 }, 
                    html2canvas: { scale: 2, useCORS: true }, 
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } 
                };
                html2pdf().set(opt).from(element).save();
            };

            // --- RECEIPT PRINT (Direct Window Print) ---
            const handlePrintReceipt = () => {
                window.print();
            };

            const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 1).getDay();
            const days = []; for(let i=0; i<firstDayOfMonth; i++) days.push(null); for(let i=1; i<=getDaysInMonth(calendarDate); i++) days.push(i);
            const getBookingsForDate = (day) => { if(!day) return []; const dateStr = `${calendarDate.getFullYear()}-${String(calendarDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`; return bookings.filter(b => b.status !== 'ยกเลิก' && b.checkIn <= dateStr && b.checkOut > dateStr); };

            // --- Room Manager Logic (Fix: Merge Editing Data Before Save) ---
            const handleMapClick = (e) => {
                if (!editingRoom) return;
                const rect = e.target.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                setEditingRoom({ ...editingRoom, x: Math.round(x), y: Math.round(y) });
            };

            const saveRoomChanges = () => {
                // [FIXED] Combine current editing room into the list before saving
                let finalRoomsData = [...roomsMapData];
                if (editingRoom) {
                    const idx = finalRoomsData.findIndex(r => r.id === editingRoom.id);
                    if (idx > -1) {
                        finalRoomsData[idx] = editingRoom;
                    } else {
                        finalRoomsData.push(editingRoom);
                    }
                }

                confirmMsg('ยืนยันการบันทึกข้อมูลห้องพักและแผนที่?', () => {
                    setSavingSiteSettings(true);
                    
                    // Prepare Payload
                    const rooms = finalRoomsData.map(r => ({
                        id: r.id, name: r.name, type: r.type, min: r.min, maxCap: r.maxCap, pricing: r.pricing, bf: r.bf
                    }));
                    const mapConfigObj = {};
                    finalRoomsData.forEach(r => mapConfigObj[r.id] = { x: r.x, y: r.y });
                    const images = {}, descs = {};
                    finalRoomsData.forEach(r => {
                        images[r.id] = r.images || [];
                        descs[r.id] = r.desc || '';
                    });

                    fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'saveRoomSystem',
                            password: password,
                            rooms: rooms,
                            mapConfig: mapConfigObj,
                            siteSettings: { roomImages: images, roomDescriptions: descs }
                        })
                    })
                    .then(r => r.json())
                    .then(res => {
                        setSavingSiteSettings(false);
                        if(res.status === 'success') {
                            successMsg('บันทึกข้อมูลสำเร็จ');
                            fetchRoomConfig(); fetchMapConfig(); fetchSettings();
                            setEditingRoom(null); // Clear editing state after success
                        } else errorMsg('บันทึกไม่สำเร็จ: ' + res.message);
                    })
                    .catch(e => {
                         setSavingSiteSettings(false);
                         errorMsg('Connection Error: ' + e.message);
                    });
                });
            };

            const updateEditingRoomInList = () => {
                setRoomsMapData(prev => {
                    const idx = prev.findIndex(r => r.id === editingRoom.id);
                    if (idx > -1) {
                        const newArr = [...prev];
                        newArr[idx] = editingRoom;
                        return newArr;
                    }
                    return [...prev, editingRoom];
                });
                setEditingRoom(null);
            };

            if (!isLoggedIn) return ( <div className="min-h-screen flex items-center justify-center bg-gray-900 px-4 relative"> <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm z-10"> <div className="text-center mb-6"><h1 className="text-3xl font-bold text-green-800">Admin Panel</h1><p className="text-gray-500">ขนำลุงดำ แคมป์ปิ้ง</p></div> <form onSubmit={handleLogin} className="space-y-4"> <input type="password" placeholder="รหัสผ่าน" className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" value={password} onChange={e => setPassword(e.target.value)} /> <button disabled={loading} className="w-full bg-gray-800 text-white p-3 rounded-lg hover:bg-gray-700 transition font-bold shadow-lg">{loading ? 'กำลังตรวจสอบ...' : 'เข้าสู่ระบบ'}</button> </form> </div> {modal.isOpen && ( <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm transition-opacity"> <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden animate-modal"> <div className={`p-6 text-center ${modal.type==='error'?'bg-red-50':''}`}> <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${modal.type==='error'?'bg-red-100 text-red-500':'bg-gray-100 text-gray-500'}`}> <i className={`fas ${modal.type==='error'?'fa-times':'fa-info'} text-2xl`}></i> </div> <h3 className="text-xl font-bold text-gray-800 mb-2">{modal.title}</h3> <p className="text-gray-600 text-sm">{modal.message}</p> </div> <div className="p-4 bg-gray-50"> <button onClick={closeModal} className="w-full py-2.5 bg-gray-800 text-white rounded-xl font-bold hover:bg-gray-700 transition">ตกลง</button> </div> </div> </div> )} </div> );

            return (
                <div className="min-h-screen bg-gray-100 font-sans">
                    
                    {/* WRAPPER FOR SCREEN CONTENT ONLY */}
                    <div className="no-print">
                        <nav className="bg-white shadow p-3 sticky top-0 z-20 flex justify-between items-center">
                            <div className="font-bold text-lg text-green-800 flex items-center gap-2"><i className="fas fa-campground"></i> จัดการระบบ</div>
                            <div className="flex gap-2">
                                <button onClick={fetchData} className="w-8 h-8 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 transition"><i className="fas fa-sync"></i></button>
                                <button onClick={() => window.location.reload()} className="w-8 h-8 bg-red-50 rounded-full text-red-500 hover:bg-red-100 transition"><i className="fas fa-power-off"></i></button>
                            </div>
                        </nav>

                        <div className="max-w-7xl mx-auto p-3 md:p-6">
                            <div className="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
                                <button onClick={() => setActiveTab('dashboard')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${activeTab==='dashboard'?'bg-green-600 text-white shadow-lg transform scale-105':'bg-white text-gray-600 shadow hover:bg-gray-50'}`}><i className="fas fa-chart-line mr-1"></i> ภาพรวม</button>
                                <button onClick={() => setActiveTab('bookings')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${activeTab==='bookings'?'bg-green-600 text-white shadow-lg transform scale-105':'bg-white text-gray-600 shadow hover:bg-gray-50'}`}><i className="fas fa-list mr-1"></i> รายการจอง</button>
                                <button onClick={() => setActiveTab('calendar')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${activeTab==='calendar'?'bg-green-600 text-white shadow-lg transform scale-105':'bg-white text-gray-600 shadow hover:bg-gray-50'}`}><i className="fas fa-calendar-alt mr-1"></i> ปฏิทิน</button>
                                <button onClick={() => setActiveTab('rooms_map')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${activeTab==='rooms_map'?'bg-green-600 text-white shadow-lg transform scale-105':'bg-white text-gray-600 shadow hover:bg-gray-50'}`}><i className="fas fa-map-marked-alt mr-1"></i> ห้องพัก & แผนที่</button>
                                <button onClick={() => setActiveTab('settings')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${activeTab==='settings'?'bg-green-600 text-white shadow-lg transform scale-105':'bg-white text-gray-600 shadow hover:bg-gray-50'}`}><i className="fas fa-cogs mr-1"></i> ตั้งค่าระบบ</button>
                            </div>

                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-green-500">
                                            <div className="text-gray-500 text-xs mb-1">รายได้รวม (มัดจำ)</div>
                                            <div className="text-2xl font-bold text-green-700">{stats.totalRevenue.toLocaleString()} ฿</div>
                                        </div>
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-blue-500">
                                            <div className="text-gray-500 text-xs mb-1">รายได้เดือนนี้</div>
                                            <div className="text-2xl font-bold text-blue-700">{stats.monthlyRevenue.toLocaleString()} ฿</div>
                                        </div>
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-yellow-500">
                                            <div className="text-gray-500 text-xs mb-1">รอตรวจสอบ</div>
                                            <div className="text-2xl font-bold text-yellow-600">{stats.pendingCount} รายการ</div>
                                        </div>
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-gray-500">
                                            <div className="text-gray-500 text-xs mb-1">การจองทั้งหมด</div>
                                            <div className="text-2xl font-bold text-gray-700">{bookings.length}</div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-2xl shadow-sm">
                                            <h3 className="font-bold text-gray-700 mb-6 flex items-center gap-2"><i className="fas fa-chart-bar text-green-500"></i> ยอดจองรายเดือน (ปีนี้)</h3>
                                            <div className="flex gap-2 h-48 pb-2">
                                                {stats.monthlyCounts.map((count, i) => (
                                                    <div key={i} className="flex-1 flex flex-col justify-end items-center group relative h-full">
                                                        <div className="absolute mb-1 bottom-full opacity-0 group-hover:opacity-100 transition text-xs font-bold text-green-700 bg-green-50 px-2 py-1 rounded border border-green-200 pointer-events-none z-10 shadow-sm whitespace-nowrap">
                                                            {count} รายการ
                                                        </div>
                                                        <div 
                                                            className="w-full bg-green-500 rounded-t hover:bg-green-600 transition-all duration-300 relative shadow-sm" 
                                                            style={{ height: `${count > 0 ? (count / (Math.max(...stats.monthlyCounts) || 1)) * 85 : 2}%` }}
                                                        ></div>
                                                        <div className="text-[10px] text-gray-400 mt-2">{["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."][i]}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm">
                                            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><i className="fas fa-clock text-blue-500"></i> เข้าพักเร็วๆ นี้ (3 วัน)</h3>
                                            <div className="space-y-3 overflow-y-auto max-h-40 pr-2">
                                                {stats.upcoming.length === 0 && <p className="text-gray-400 text-sm text-center py-4">ไม่มีรายการเร็วๆ นี้</p>}
                                                {stats.upcoming.map(b => (
                                                    <div key={b.id} onClick={()=>setViewBooking(b)} className="flex justify-between items-center p-3 bg-blue-50 rounded-xl cursor-pointer hover:bg-blue-100 transition">
                                                        <div>
                                                            <div className="font-bold text-sm text-gray-800">{b.name}</div>
                                                            <div className="text-xs text-blue-600"><i className="fas fa-calendar-day mr-1"></i>{formatThaiDate(b.checkIn)}</div>
                                                        </div>
                                                        <div className="text-xs bg-white px-2 py-1 rounded-lg border border-blue-200 text-blue-500 font-bold shadow-sm">{b.rooms.split(',')[0].substring(0, 10)}..</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'bookings' && (
                                <div>
                                    <div className="flex flex-col md:flex-row gap-4 mb-4 items-center justify-between">
                                        <div className="flex gap-2 overflow-x-auto pb-2 w-full md:w-auto">
                                            {['all', 'pending', 'confirmed', 'upcoming', 'history'].map(f => (
                                                <button key={f} onClick={() => setFilter(f)} className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${filter === f ? 'bg-gray-800 text-white shadow' : 'bg-white text-gray-600 border hover:bg-gray-50'}`}>{f === 'all' ? 'ทั้งหมด' : (f === 'pending' ? 'รอตรวจสอบ' : (f === 'confirmed' ? 'ยืนยันแล้ว' : (f === 'upcoming' ? 'เร็วๆ นี้' : 'ประวัติ')))}</button>
                                            ))}
                                        </div>
                                        
                                        <div className="relative w-full md:w-64">
                                            <i className="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            <input 
                                                type="text" 
                                                placeholder="ค้นหา (ID, ชื่อ, เบอร์, LINE)" 
                                                className="w-full pl-10 pr-4 py-2 rounded-full border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={searchTerm}
                                                onChange={e => setSearchTerm(e.target.value)}
                                            />
                                        </div>

                                        <div className="flex gap-2 w-full md:w-auto">
                                            <button onClick={() => setShowAdminBooking(true)} className="flex-1 md:flex-none px-4 py-2 bg-blue-600 text-white rounded-full text-xs font-bold hover:bg-blue-700 shadow flex items-center justify-center gap-1 transition"><i className="fas fa-plus"></i> Walk-in</button>
                                            <button onClick={handleExport} className="flex-1 md:flex-none px-4 py-2 bg-green-600 text-white rounded-full text-xs font-bold hover:bg-green-700 shadow flex items-center justify-center gap-1 transition"><i className="fas fa-file-excel"></i> Excel</button>
                                            <button onClick={handlePrintReport} className="flex-1 md:flex-none px-4 py-2 bg-red-600 text-white rounded-full text-xs font-bold hover:bg-red-700 shadow flex items-center justify-center gap-1 transition"><i className="fas fa-print"></i> Report</button>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        {filteredBookings.length === 0 && <div className="text-center text-gray-400 py-10">ไม่พบข้อมูลการจอง</div>}
                                        {filteredBookings.map(b => (
                                            <div key={b.id} className="bg-white rounded-xl shadow-sm hover:shadow-md transition p-5 border-l-4 border-green-500 relative group">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div><div className="text-xs text-gray-400 font-mono mb-0.5">{b.id} • {b.timestamp.split(' ')[0]}</div><div className="font-bold text-lg text-gray-800">{b.name}</div></div>
                                                    <StatusBadge status={b.status} />
                                                </div>
                                                <div className="text-sm text-gray-600 mb-3 space-y-1">
                                                    <div className="flex items-center gap-2"><i className="fas fa-phone w-4 text-center text-gray-400"></i> <a href={`tel:${b.phone}`} className="hover:text-green-600">{b.phone}</a></div>
                                                    <div className="flex items-center gap-2"><i className="fab fa-line w-4 text-center text-gray-400"></i> {b.lineProfile}</div>
                                                </div>
                                                <div className="bg-gray-50 p-3 rounded-lg text-sm mb-3 border border-gray-100">
                                                    <div className="flex justify-between mb-1"><span>เข้าพัก:</span> <b className="text-gray-700">{formatThaiDate(b.checkIn)}</b></div>
                                                    <div className="flex justify-between"><span>คืนห้อง:</span> <b className="text-gray-700">{formatThaiDate(b.checkOut)}</b></div>
                                                    <hr className="my-2 border-gray-200"/>
                                                    <div className="font-medium text-green-700 text-sm whitespace-pre-wrap"><i className="fas fa-home mr-1"></i> {b.rooms}</div>
                                                    {b.food !== '-' && <div className="text-orange-600 text-xs mt-1"><i className="fas fa-utensils mr-1"></i> {b.food}</div>}
                                                </div>
                                                <div className="flex justify-between items-center bg-blue-50 p-2 rounded-lg mb-3">
                                                    <div className="text-center px-2"><div className="text-[10px] text-gray-500">ยอดสุทธิ</div><div className="font-bold text-gray-800">{parseInt(b.price).toLocaleString()}</div></div>
                                                    <div className="h-8 w-px bg-blue-200"></div>
                                                    <div className="text-center px-2"><div className="text-[10px] text-gray-500">มัดจำ</div><div className="font-bold text-red-600">{parseInt(b.deposit).toLocaleString()}</div></div>
                                                    <div className="h-8 w-px bg-blue-200"></div>
                                                    <div className="text-center px-2"><div className="text-[10px] text-gray-500">คงเหลือ</div><div className="font-bold text-green-600">{(parseInt(b.price) - parseInt(b.deposit)).toLocaleString()}</div></div>
                                                </div>
                                                <div className="flex justify-end gap-2">
                                                    {String(b.slip || '').includes('http') && <button onClick={() => setViewSlip(b.slip)} className="bg-blue-50 text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-100 transition text-sm font-bold"><i className="fas fa-image mr-1"></i> สลิป</button>}
                                                    <button onClick={() => { setViewBooking(b); }} className="bg-orange-50 text-orange-600 px-3 py-2 rounded-lg hover:bg-orange-100 transition text-sm font-bold"><i className="fas fa-edit mr-1"></i> จัดการ</button>
                                                    {b.status === 'รอตรวจสอบ' && (<><button onClick={() => updateStatus(b.id, 'ยืนยัน')} className="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition text-sm font-bold shadow-sm">ยืนยัน</button><button onClick={() => updateStatus(b.id, 'ยกเลิก')} className="bg-white border border-red-200 text-red-500 px-3 py-2 rounded-lg hover:bg-red-50 transition text-sm font-bold">ยกเลิก</button></>)}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'calendar' && (
                                <div className="bg-white rounded-lg shadow p-4">
                                    <div className="flex justify-between items-center mb-4">
                                        <button onClick={()=>setCalendarDate(new Date(calendarDate.setMonth(calendarDate.getMonth()-1)))} className="p-2 bg-gray-100 rounded hover:bg-gray-200"><i className="fas fa-chevron-left"></i></button>
                                        <h2 className="text-xl font-bold">{calendarDate.toLocaleString('th-TH', { month: 'long', year: 'numeric' })}</h2>
                                        <button onClick={()=>setCalendarDate(new Date(calendarDate.setMonth(calendarDate.getMonth()+1)))} className="p-2 bg-gray-100 rounded hover:bg-gray-200"><i className="fas fa-chevron-right"></i></button>
                                    </div>
                                    <div className="grid grid-cols-7 gap-1 text-center text-xs md:text-sm font-bold bg-gray-200 p-2 rounded-t">
                                        <div>อา</div>
